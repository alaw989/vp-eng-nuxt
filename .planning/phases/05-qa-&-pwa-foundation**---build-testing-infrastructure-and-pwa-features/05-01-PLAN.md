---
phase: 05-qa-&-pwa-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [nuxt.config.ts]
autonomous: true

must_haves:
  truths:
    - "Service worker caches app shell resources (layouts, CSS, JS, fonts, icons)"
    - "Offline page displays when network is unavailable"
    - "Previously visited pages are accessible offline"
    - "Service worker updates trigger user-friendly reload prompt"
  artifacts:
    - path: "nuxt.config.ts"
      provides: "PWA configuration with cache-first app shell strategy"
      contains: "pwa.workbox.runtimeCaching"
    - path: "pages/offline.vue"
      provides: "Offline fallback page"
      contains: "You're Offline"
    - path: "components/PwaReloadPrompt.vue"
      provides: "Service worker update notification"
      contains: "updateApp"
  key_links:
    - from: "nuxt.config.ts"
      to: "pages/offline.vue"
      via: "navigateFallback"
      pattern: "navigateFallback.*offline"
    - from: "components/PwaReloadPrompt.vue"
      to: "$pwa.updateServiceWorker"
      via: "PWA composable"
      pattern: "updateServiceWorker"
---

<objective>
Verify and refine offline support with cache-first app shell strategy. The application should function offline with a helpful fallback page and cached core resources (layouts, CSS, JS, fonts, icons).

Purpose: Offline capability improves user experience and engagement. Users can browse previously viewed content even without network connectivity.

Output: Verified service worker configuration with cache-first strategy for app shell, tested offline functionality, refined caching rules.
</objective>

<execution_context>
@/home/deck/.claude/get-shit-done/workflows/execute-plan.md
@/home/deck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-qa-&-pwa-foundation**---build-testing-infrastructure-and-pwa-features/05-CONTEXT.md
@.planning/phases/05-qa-&-pwa-foundation**---build-testing-infrastructure-and-pwa-features/05-RESEARCH.md
@nuxt.config.ts
@pages/offline.vue
@components/PwaReloadPrompt.vue
</context>

<tasks>

<task type="auto">
  <name>Verify existing PWA configuration in nuxt.config.ts</name>
  <files>nuxt.config.ts</files>
  <action>
    Review the existing PWA configuration in nuxt.config.ts (lines 182-290).

    Current state:
    - @vite-pwa/nuxt is installed and configured
    - navigateFallback is set to '/offline'
    - Runtime caching includes NetworkFirst for WordPress API, CacheFirst for images, CacheFirst for Google Fonts, StaleWhileRevalidate for static assets

    Required updates based on Phase 5 Context decisions:
    1. Ensure CacheFirst strategy is used for app shell (layouts, CSS, JS)
    2. Resources to cache: app shell only â€” layouts, CSS, JS, fonts, icons (~10-20 resources)
    3. Verify globPatterns includes appropriate file types

    Update nuxt.config.ts pwa.workbox section:
    - Add globPatterns for precaching: '**/*.{js,css,html,svg,png,jpg,jpeg,woff2}'
    - Ensure JS/CSS uses CacheFirst (already has StaleWhileRevalidate - change to CacheFirst for faster loads)
    - Keep Google Fonts as CacheFirst (already correct)
    - Keep images as CacheFirst (already correct)
    - Keep WordPress API as NetworkFirst (already correct)

    DO NOT change:
    - navigateFallback: '/offline' (already correct)
    - devOptions.enabled: false (keep disabled in dev, will test with build)
    - manifest configuration (already correct)
  </action>
  <verify>
    After editing, verify nuxt.config.ts contains:
    - globPatterns: ['**/*.{js,css,html,svg,png,jpg,jpeg,woff2}']
    - CacheFirst handler for JS/CSS urlPattern
    - CacheFirst handler for Google Fonts urlPattern
    - CacheFirst handler for images urlPattern
    - NetworkFirst handler for WordPress API urlPattern
  </verify>
  <done>
    PWA configuration specifies CacheFirst for app shell (JS, CSS, fonts) and NetworkFirst for dynamic content (WordPress API).
  </done>
</task>

<task type="auto">
  <name>Build and test offline functionality</name>
  <files>.output/public/sw.js, .output/public/offline.html</files>
  <action>
    Build the application and test offline functionality:

    1. Run build: npm run build
    2. Start preview server: npm run preview
    3. Wait 5 seconds for server to fully start

    Verify service worker is generated:
    - Check that .output/public/sw.js exists and contains Workbox code
    - Check that .output/public/offline.html exists (prerendered offline page)

    Test offline behavior using Chrome DevTools:
    1. Open http://localhost:3000 in Chrome
    2. Open DevTools > Application > Service Workers
    3. Verify service worker is active and running
    4. Open DevTools > Network tab
    5. Check "Offline" checkbox to simulate offline mode
    6. Navigate to http://localhost:3000
    7. Verify offline page loads with "You're Offline" message
    8. Try navigating to /about - should show cached content or offline page

    Kill preview server after testing: Ctrl+C

    Note: Since devOptions.enabled: false, PWA features only work in build/preview mode (not dev mode).
  </action>
  <verify>
    - .output/public/sw.js exists and is non-empty
    - .output/public/offline.html exists
    - Service worker is active in Chrome DevTools
    - Offline page loads when network is disabled
    - Cached pages load offline
  </verify>
  <done>
    Service worker is generated, caches app shell resources, and offline page displays correctly when network is unavailable.
  </done>
</task>

<task type="auto">
  <name>Verify PWA reload prompt component integration</name>
  <files>layouts/default.vue, components/PwaReloadPrompt.vue</files>
  <action>
    Verify that PwaReloadPrompt component is properly integrated and will notify users of service worker updates.

    Check layouts/default.vue:
    - Verify <LazyPwaReloadPrompt /> is included (line 24)
    - Verify <LazyPwaInstallPrompt /> is included (line 25)

    The PwaReloadPrompt component:
    - Shows "Update Available" when $pwa.needRefresh is true
    - Shows "App Ready to Work Offline" when $pwa.offlineReady is true
    - Calls $pwa.updateServiceWorker(true) when user clicks Reload
    - Already exists in components/PwaReloadPrompt.vue

    No changes needed - just verify integration is correct.

    Note: Per Phase 5 Context decision, install prompt should be browser native only. The existing PwaInstallPrompt component will be addressed in plan 05-02.
  </action>
  <verify>
    - layouts/default.vue includes <LazyPwaReloadPrompt />
    - components/PwaReloadPrompt.vue exists and handles needRefresh and offlineReady states
    - Component calls $pwa.updateServiceWorker(true) for updates
  </verify>
  <done>
    Service worker updates trigger user-friendly reload prompt via PwaReloadPrompt component.
  </done>
</task>

</tasks>

<verification>
Overall verification of offline support:

1. Service worker file (.output/public/sw.js) exists and contains Workbox precache and runtime caching strategies
2. Offline page (.output/public/offline.html) is prerendered
3. Navigate to http://localhost:3000 with network disabled shows "You're Offline" page
4. Cached pages are accessible offline
5. Service worker update prompt appears when new version is available

Run: npm run build && npm run preview
Then test in Chrome DevTools with Network > Offline checkbox enabled.
</verification>

<success_criteria>
1. Application functions offline with helpful /offline fallback page
2. Core resources (app shell: layouts, CSS, JS, fonts, icons) are cached with CacheFirst strategy
3. Previously visited pages are accessible when offline
4. Service worker updates trigger reload prompt (PwaReloadPrompt component)
5. Build completes without errors and preview mode has active service worker
</success_criteria>

<output>
After completion, create `.planning/phases/05-qa-&-pwa-foundation**---build-testing-infrastructure-and-pwa-features/05-01-SUMMARY.md` with:
- PWA configuration changes made
- Service worker caching strategy summary
- Offline testing results
- Any issues encountered and resolutions
</output>
