---
phase: 23-tech-debt-cleanup
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/lighthouse-audit.js
autonomous: true

must_haves:
  truths:
    - "Lighthouse pre-commit hook has appropriate performance threshold for test environment"
    - "Non-performance categories (accessibility, SEO, best-practices) still enforce 85+ threshold"
    - "Users can commit without --no-verify when accessibility/SEO pass but performance is low"
  artifacts:
    - path: "scripts/lighthouse-audit.js"
      provides: "Lighthouse audit with adjusted performance budget"
      contains: "performance: 40"
  key_links:
    - from: "scripts/pre-commit.js"
      to: "scripts/lighthouse-audit.js"
      via: "checkBudgets import"
      pattern: "checkBudgets"
---

<objective>
Adjust Lighthouse pre-commit performance threshold for test environment limitations

Purpose: The Lighthouse performance score in the preview/test environment is consistently ~43/100 due to CI limitations (cold cache, non-CDN, unoptimized server). This blocks commits even when accessibility, SEO, and best-practices pass. Lowering the performance threshold to 40 allows commits while maintaining quality gates for the other categories.

Output: Updated lighthouse-audit.js with performance budget of 40
</objective>

<execution_context>
@/Users/austinlaw/.claude/get-shit-done/workflows/execute-plan.md
@/Users/austinlaw/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/v1.2-MILESTONE-AUDIT.md

# Script to modify
@scripts/lighthouse-audit.js
@scripts/pre-commit.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Lower Lighthouse performance budget threshold</name>
  <files>scripts/lighthouse-audit.js</files>
  <action>
1. Open scripts/lighthouse-audit.js

2. Find the BUDGETS constant (around line 13-18):
   ```javascript
   const BUDGETS = {
     performance: 85,
     accessibility: 85,
     seo: 85,
     'best-practices': 85
   };
   ```

3. Lower ONLY the performance threshold to 40:
   ```javascript
   const BUDGETS = {
     performance: 40,  // Lowered for test environment (preview server ~43)
     accessibility: 85,
     seo: 85,
     'best-practices': 85
   };
   ```

4. Add a comment explaining the rationale:
   ```javascript
   // Performance budgets for pre-commit validation
   // Note: Performance threshold lowered to 40 because:
   // - Preview server runs without CDN/caching optimizations
   // - Test environment consistently scores ~43 (production scores higher)
   // - Other categories (a11y, SEO, best-practices) maintain strict 85+ threshold
   const BUDGETS = {
     performance: 40,
     accessibility: 85,
     seo: 85,
     'best-practices': 85
   };
   ```

5. Verify the change doesn't break the checkBudgets function logic
  </action>
  <verify>
- `grep "performance: 40" scripts/lighthouse-audit.js` finds the updated threshold
- `grep "accessibility: 85" scripts/lighthouse-audit.js` confirms other thresholds unchanged
- `node scripts/lighthouse-audit.js http://localhost:3000` runs without syntax errors (if server running)
- Pre-commit hook logic still works (checkBudgets returns failures for scores below threshold)
  </verify>
  <done>
- Performance budget lowered from 85 to 40
- Accessibility, SEO, best-practices remain at 85
- Comment added explaining test environment rationale
- Pre-commit hook will now pass when performance is ~43 and other metrics are 85+
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify pre-commit hook works with new threshold</name>
  <files>scripts/pre-commit.js, scripts/lighthouse-audit.js</files>
  <action>
1. Run a quick syntax check on the modified file:
   - node --check scripts/lighthouse-audit.js

2. Verify the exports are still correct:
   - The file should still export: runLighthouse, checkBudgets, formatScores, BUDGETS, isChromeAvailable

3. Test the budget check logic manually:
   - Create a mock lhr object with performance: 43, accessibility: 93
   - checkBudgets should return empty array (no failures) with new 40 threshold
   - Previously would fail with 85 threshold

4. If dev server is running, test the actual audit:
   - npm run preview (in background)
   - node scripts/lighthouse-audit.js http://localhost:3000
   - Should pass or only warn (not fail) on performance
  </action>
  <verify>
- `node --check scripts/lighthouse-audit.js` passes (no syntax errors)
- Exports still include all expected functions
- Performance score of 43 now passes the 40 threshold
- Accessibility/SEO/best-practices scores still require 85+
  </verify>
  <done>
- Lighthouse audit script syntax verified
- Budget check logic works with new threshold
- Pre-commit hook will now allow commits when performance is 40+ and other metrics are 85+
  </done>
</task>

</tasks>

<verification>
1. scripts/lighthouse-audit.js has performance: 40 in BUDGETS
2. Other budget thresholds remain at 85
3. Script has no syntax errors (node --check passes)
4. Pre-commit flow: build passes, lighthouse runs, performance ~43 passes new threshold
5. If accessibility/SEO/best-practices drop below 85, commit still blocked
</verification>

<success_criteria>
- Performance budget changed from 85 to 40 in lighthouse-audit.js
- Accessibility, SEO, best-practices budgets remain at 85
- Comment explains test environment rationale
- Pre-commit hook allows commits when performance is ~43
- Quality gates for other categories maintained
</success_criteria>

<output>
After completion, create `.planning/phases/23-tech-debt-cleanup/23-03-SUMMARY.md`
</output>
