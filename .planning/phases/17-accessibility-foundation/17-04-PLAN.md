---
phase: 17-accessibility-foundation
plan: 04
type: execute
wave: 2
depends_on: ["17-03"]
files_modified:
  - components/ProjectGallery.vue
  - composables/useFocusManager.ts
  - layouts/default.vue
  - assets/css/main.css
autonomous: true

must_haves:
  truths:
    - "useFocusTrap from VueUse manages modal focus (ProjectGallery lightbox)"
    - "Focus returns to triggering element after modal closes"
    - "Focus indicators are visible (2px minimum, high contrast)"
    - "Route changes announce focus to main content or skip link target"
    - "No focus visible issues in DevTools A11y panel"
  artifacts:
    - path: "composables/useFocusManager.ts"
      provides: "Focus management composable for modal/restoration"
      min_lines: 40
      exports: ["useFocusTrap", "useFocusRestoration", "useRouteFocus"]
    - path: "components/ProjectGallery.vue"
      provides: "Modal with VueUse focus trap"
      contains: "useFocusTrap"
    - path: "assets/css/main.css"
      provides: "Global focus indicator styles"
      contains: "focus-visible"
  key_links:
    - from: "composables/useFocusManager.ts"
      to: "VueUse"
      via: "useFocusTrap from @vueuse/integrations/useFocusTrap"
      pattern: "useFocusTrap"
    - from: "components/ProjectGallery.vue"
      to: "useFocusManager.ts"
      via: "import statement"
      pattern: "useFocusTrap|useFocusRestoration"
    - from: "assets/css/main.css"
      to: "WCAG A11Y-06"
      via: "CSS focus-visible styles"
      pattern: "focus-visible|:focus"
---

<objective>
Implement focus management using VueUse's useFocusTrap for modals, focus restoration for overlays, and enhance focus indicators for visibility. This satisfies requirements A11Y-06 (focus management) and A11Y-08 (focus traps for modals).

Purpose: A11Y-06 requires logical tab order and focus return after modals. A11Y-08 requires focus traps for modals. ProjectGallery has custom focus trap that should be replaced with VueUse useFocusTrap for consistency and reliability.

Output: Focus management composable, ProjectGallery using VueUse focus trap, enhanced focus indicators, and route change focus management.
</objective>

<execution_context>
@/home/deck/.claude/get-shit-done/workflows/execute-plan.md
@/home/deck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/17-accessibility-foundation/17-RESEARCH.md

# Research findings:
- VueUse useFocusTrap provides robust focus management for modals
- Focus trap edge cases: Tab, Shift+Tab, focusable element detection
- Focus restoration: track trigger element and restore after modal close
- Focus indicators: 2px minimum, high contrast (WCAG AA)
- Don't hand-roll focus traps - use VueUse

# Current state from codebase review:
- **ProjectGallery.vue**: Has custom focus trap implementation (lines 213-231)
  - Manual Tab/Shift+Tab handling
  - Focus restoration via `previouslyFocused` ref (lines 207, 239, 252)
  - Should be replaced with VueUse useFocusTrap

- **HeroSlider.vue**: Has tabindex="0" for keyboard focus (line 7)

- **BackToTop.vue**: Has focus-visible ring styles (line 13)

- **AppHeader.vue**: Has focus-visible ring styles on nav links

# Focus indicator requirements (A11Y-06):
- 2px minimum outline width
- High contrast against background
- Visible on all focusable elements (buttons, links, inputs)

# Focus trap requirements (A11Y-08):
- Tab cycles within modal
- Shift+Tab cycles in reverse
- Focus returns to trigger after close
</context>

<tasks>

<task type="auto">
  <name>Create focus management composable</name>
  <files>composables/useFocusManager.ts</files>
  <action>
    Create `composables/useFocusManager.ts` with focus management utilities:

    ```typescript
    import { useFocusTrap } from '@vueuse/integrations/useFocusTrap'
    import { useTemplateRef, nextTick } from 'vue'
    import type { Ref } from 'vue'

    /**
     * VueUse wrapper for modal focus traps
     * Automatically activates when isOpen becomes true
     * @param trapRef - Ref to the modal container element
     * @param isOpen - Ref tracking modal open state
     * @param options - VueUse focus trap options
     */
    export function useModalFocusTrap(
      trapRef: Ref<HTMLElement | undefined>,
      isOpen: Ref<boolean>,
      options: {
        escapeDeactivates?: boolean
        clickOutsideDeactivates?: boolean
        initialFocus?: string | (() => HTMLElement)
      } = {}
    ) {
      const { hasFocus, activate, deactivate } = useFocusTrap(trapRef, {
        immediate: false,
        ...options
      })

      // Activate trap when modal opens
      const open = async () => {
        isOpen.value = true
        await nextTick()
        activate()
      }

      // Deactivate trap when modal closes
      const close = async () => {
        isOpen.value = false
        deactivate()
      }

      return {
        hasFocus,
        activate,
        deactivate,
        open,
        close
      }
    }

    /**
     * Focus restoration for modals/overlays
     * Tracks the element that opened a modal and restores focus on close
     */
    export function useFocusRestoration() {
      const triggerRef = ref<HTMLElement | null>(null)

      /**
       * Call before opening modal to save current focus
       */
      const saveFocus = () => {
        triggerRef.value = document.activeElement as HTMLElement
      }

      /**
       * Call after closing modal to restore focus
       */
      const restoreFocus = async () => {
        await nextTick()
        triggerRef.value?.focus()
      }

      /**
       * Get the saved trigger element
       */
      const getTrigger = () => triggerRef.value

      return {
        saveFocus,
        restoreFocus,
        getTrigger,
        triggerRef
      }
    }

    /**
     * Route change focus management
     * Moves focus to skip link target or main content on route change
     */
    export function useRouteFocus() {
      const route = useRoute()

      const focusMainContent = async () => {
        await nextTick()
        const mainContent = document.getElementById('main-content')
        if (mainContent) {
          mainContent.tabIndex = -1
          mainContent.focus()
        }
      }

      // Focus main content on route change
      watch(() => route.path, () => {
        focusMainContent()
      })

      return {
        focusMainContent
      }
    }
    ```

    This composable wraps VueUse useFocusTrap with focus restoration and route focus utilities.
    DO NOT implement custom focus trap logic (VueUse handles all edge cases).
  </action>
  <verify>
    1. File `composables/useFocusManager.ts` exists
    2. `grep "export function" composables/useFocusManager.ts` shows three exports
    3. `grep "useFocusTrap" composables/useFocusManager.ts` shows VueUse import
    4. `npm run dev` starts without TypeScript errors
  </verify>
  <done>
    useFocusManager composable exists with useModalFocusTrap, useFocusRestoration, and useRouteFocus
  </done>
</task>

<task type="auto">
  <name>Replace custom focus trap with VueUse in ProjectGallery</name>
  <files>components/ProjectGallery.vue</files>
  <action>
    Replace custom focus trap implementation with VueUse useFocusTrap:

    1. Remove custom focus trap code (lines 213-231 - trapFocus function)

    2. Import useModalFocusTrap from composable:
       ```typescript
       import { useModalFocusTrap, useFocusRestoration } from '~/composables/useFocusManager'
       import { useTemplateRef } from 'vue'
       ```

    3. Replace custom trap with VueUse:
       ```typescript
       const lightboxRef = useTemplateRef<HTMLElement>('lightbox')
       const lightboxOpen = ref(false)

       // Use VueUse focus trap
       const { activate, deactivate } = useModalFocusTrap(
         lightboxRef,
         lightboxOpen
       )

       // Focus restoration
       const { saveFocus, restoreFocus } = useFocusRestoration()

       const openLightbox = (index: number) => {
         currentImageIndex.value = index
         saveFocus() // Save current focus
         activate() // Activate focus trap
         document.body.style.overflow = 'hidden'
       }

       const closeLightbox = () => {
         deactivate() // Deactivate focus trap
         restoreFocus() // Restore focus to trigger
         document.body.style.overflow = ''
       }
       ```

    4. Remove the watch that manually adds/removes keydown listener (lines 299-307)

    5. Keep the onKeyStroke handlers for arrow navigation (they're for navigation within the lightbox, not focus trapping)

    6. Ensure the lightbox container has:
       - `ref="lightboxRef"`
       - `role="dialog"`
       - `aria-modal="true"`
       - `:aria-label` (already present)

    DO NOT change the lightbox styling or transition animations.
  </action>
  <verify>
    1. `grep "useFocusTrap\|useModalFocusTrap" components/ProjectGallery.vue` shows VueUse usage
    2. `grep "trapFocus" components/ProjectGallery.vue` returns nothing (custom code removed)
    3. `grep "saveFocus\|restoreFocus" components/ProjectGallery.vue` shows focus restoration
    4. `npm run dev` starts without errors
    5. Test: Open lightbox, Tab cycles within lightbox, close returns focus to trigger
  </verify>
  <done>
    ProjectGallery uses VueUse focus trap with proper focus restoration
  </done>
</task>

<task type="auto">
  <name>Enhance focus indicators and add route focus management</name>
  <files>
    layouts/default.vue
    assets/css/main.css
  </files>
  <action>
    Enhance focus visibility and add route change focus:

    1. **assets/css/main.css** - Add global focus-visible styles:
       ```css
       /* High contrast focus indicators for keyboard navigation */
       *:focus-visible {
         outline: 2px solid rgb(30 64 175); /* primary color */
         outline-offset: 2px;
       }

       /* Ensure focus indicators work on all elements */
       button:focus-visible,
       a:focus-visible,
       input:focus-visible,
       textarea:focus-visible,
       select:focus-visible,
       [tabindex]:focus-visible {
         outline: 2px solid rgb(30 64 175);
         outline-offset: 2px;
       }

       /* Don't show focus ring on mouse click */
       *:focus:not(:focus-visible) {
         outline: none;
       }

       /* Ensure skip link focus is very visible */
       .focus\\:not-sr-only:focus {
         outline: 3px solid white;
         outline-offset: 2px;
         box-shadow: 0 0 0 4px rgb(30 64 175);
       }
       ```

       These styles use `:focus-visible` to only show focus ring for keyboard navigation (not mouse clicks).

    2. **layouts/default.vue** - Add route focus management:
       - Import useRouteFocus from composable (if it exists)
       - Or add inline route change handler:
         ```typescript
         const route = useRoute()

         watch(() => route.path, async () => {
           await nextTick()
           const mainContent = document.getElementById('main-content')
           if (mainContent) {
             mainContent.tabIndex = -1
             mainContent.focus()
           }
         })
         ```

       This ensures focus moves to main content on route change for screen reader users.

    DO NOT remove existing focus styles from individual components (they provide component-specific overrides).
    DO NOT use `:focus` pseudo-class instead of `:focus-visible` (would show ring on mouse click).
  </action>
  <verify>
    1. `grep "focus-visible" assets/css/main.css` shows focus indicator styles
    2. `grep "route.path\|useRouteFocus" layouts/default.vue` shows route focus handler
    3. `npm run build` completes without errors
    4. Test: Tab through page - focus ring is visible on all interactive elements
    5. Test: Click with mouse - no focus ring appears
    6. Test: Navigate routes - focus moves to main content
  </verify>
  <done>
    Global focus indicators are visible (2px minimum, high contrast), route changes move focus to main content
  </done>
</task>

</tasks>

<verification>
After all tasks complete, verify:
1. `npm run dev` starts without errors
2. Tab through page - focus ring visible on all interactive elements
3. Open lightbox - Tab cycles within lightbox (focus trap works)
4. Close lightbox - focus returns to element that opened it
5. Navigate routes - focus moves to main content
6. DevTools A11y panel shows no focus-related violations
</verification>

<success_criteria>
1. VueUse useFocusTrap manages modal focus (ProjectGallery lightbox)
2. Focus returns to triggering element after modal closes
3. Focus indicators are visible on all interactive elements (2px minimum)
4. Focus indicators only show on keyboard navigation (:focus-visible)
5. Route changes move focus to main content for screen readers
6. No focus trap violations in axe-core
</success_criteria>

<output>
After completion, create `.planning/phases/17-accessibility-foundation/17-04-SUMMARY.md` with:
- Focus trap implementation details (VueUse vs custom)
- Focus indicator CSS added
- Route focus management implementation
- Any components that need additional focus work
</output>
