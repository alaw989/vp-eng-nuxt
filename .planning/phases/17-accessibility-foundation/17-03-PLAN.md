---
phase: 17-accessibility-foundation
plan: 03
type: execute
wave: 2
depends_on: ["17-01", "17-02"]
files_modified:
  - components/AppHeader.vue
  - components/HeroSlider.vue
  - components/ProjectGallery.vue
  - components/TestimonialsSlider.vue
  - components/ProjectsCarousel.vue
autonomous: true

must_haves:
  truths:
    - "Escape key closes mobile menu in AppHeader"
    - "Arrow keys navigate slider components (HeroSlider, TestimonialsSlider)"
    - "Tab key follows logical order through all interactive elements"
    - "Enter key activates all clickable elements"
    - "Keyboard can navigate entire site without mouse"
    - "No keyboard traps exist (except intentional focus traps in modals)"
  artifacts:
    - path: "composables/useKeyboardNavigation.ts"
      provides: "Composable for keyboard navigation patterns"
      min_lines: 30
      exports: ["useEscapeKey", "useArrowKeys"]
    - path: "components/AppHeader.vue"
      provides: "Mobile menu with Escape key handler"
      contains: "Escape"
    - path: "tests-e2e/keyboard-navigation.spec.ts"
      provides: "E2E test for keyboard navigation"
      min_lines: 40
  key_links:
    - from: "composables/useKeyboardNavigation.ts"
      to: "VueUse"
      via: "useMagicKeys composable"
      pattern: "useMagicKeys|useEscapeKey"
    - from: "components/AppHeader.vue"
      to: "useKeyboardNavigation.ts"
      via: "import statement"
      pattern: "useEscapeKey"
    - from: "tests-e2e/keyboard-navigation.spec.ts"
      to: "Playwright"
      via: "keyboard() and Tab key tests"
      pattern: "page.keyboard"
---

<objective>
Implement full keyboard navigation support using VueUse's useMagicKeys. Ensure Escape key closes overlays/menus, arrow keys navigate sliders/carousels, and Tab follows logical order. This satisfies requirement A11Y-03.

Purpose: A11Y-03 requires full keyboard navigation (Tab, Enter, Escape, Arrow keys). VueUse provides useMagicKeys composable for cross-platform keyboard handling. HeroSlider already has some keyboard support but other components need enhancement.

Output: Keyboard navigation composable, enhanced components with keyboard handlers, and E2E tests verifying keyboard-only navigation works.
</objective>

<execution_context>
@/home/deck/.claude/get-shit-done/workflows/execute-plan.md
@/home/deck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/17-accessibility-foundation/17-RESEARCH.md

# Research findings:
- VueUse useMagicKeys provides reactive keyboard handling
- Use `whenever` from VueUse for conditional key responses
- HeroSlider.vue already has keyboard navigation (ArrowLeft, ArrowRight, Home, End)
- ProjectGallery.vue has onKeyStroke for arrow navigation in lightbox
- AppHeader.vue mobile menu needs Escape key to close

# Current state from codebase review:
- HeroSlider.vue: HAS keyboard navigation (lines 376-395) - ArrowLeft, ArrowRight, Home, End
- ProjectGallery.vue: HAS onKeyStroke for ArrowLeft/Right, Home, End (lines 270-296)
- AppHeader.vue: NO Escape key handler for mobile menu - needs implementation
- TestimonialsSlider.vue: NEEDS keyboard navigation review
- ProjectsCarousel.vue: NEEDS keyboard navigation review

# Key requirement from A11Y-03:
- Tab: Logical tab order (native HTML handles this with proper DOM order)
- Enter: Activates buttons/links (native HTML handles this)
- Escape: Should close modals, menus, dropdowns
- Arrow keys: Should navigate sliders, carousels, grids
</context>

<tasks>

<task type="auto">
  <name>Create keyboard navigation composable</name>
  <files>composables/useKeyboardNavigation.ts</files>
  <action>
    Create `composables/useKeyboardNavigation.ts` with reusable keyboard patterns:

    ```typescript
    import { useMagicKeys, whenever } from '@vueuse/core'
    import type { Ref } from 'vue'

    /**
     * Escape key handler for closing overlays/menus
     * @param isOpen - Ref<boolean> tracking open state
     * @param callback - Optional additional cleanup function
     */
    export function useEscapeKey(isOpen: Ref<boolean>, callback?: () => void) {
      const { escape } = useMagicKeys()

      whenever(escape, () => {
        if (isOpen.value) {
          isOpen.value = false
          callback?.()
        }
      }, { immediate: true })

      return { escape }
    }

    /**
     * Arrow key handler for sliders/carousels
     * @param currentIndex - Ref<number> tracking current index
     * @param itemCount - Total number of items
     * @param isEnabled - Optional ref to only handle when enabled
     */
    export function useArrowKeys(
      currentIndex: Ref<number>,
      itemCount: number | Ref<number>,
      isEnabled?: Ref<boolean>
    ) {
      const { arrowLeft, arrowRight, arrowUp, arrowDown, home, end } = useMagicKeys()

      const count = typeof itemCount === 'number' ? ref(itemCount) : itemCount
      const enabled = isEnabled ?? ref(true)

      const goPrevious = () => {
        if (enabled.value) {
          currentIndex.value = currentIndex.value > 0
            ? currentIndex.value - 1
            : count.value - 1
        }
      }

      const goNext = () => {
        if (enabled.value) {
          currentIndex.value = (currentIndex.value + 1) % count.value
        }
      }

      const goFirst = () => {
        if (enabled.value) currentIndex.value = 0
      }

      const goLast = () => {
        if (enabled.value) currentIndex.value = count.value - 1
      }

      whenever(arrowLeft, goPrevious)
      whenever(arrowRight, goNext)
      whenever(arrowUp, goPrevious)
      whenever(arrowDown, goNext)
      whenever(home, goFirst)
      whenever(end, goLast)

      return {
        goPrevious,
        goNext,
        goFirst,
        goLast,
        arrowKeys: { arrowLeft, arrowRight, arrowUp, arrowDown, home, end }
      }
    }

    /**
     * Tab trap helper for keeping focus within a component
     * @param containerRef - Ref to the container element
     */
    export function useTabTrap(containerRef: Ref<HTMLElement | undefined>) {
      const handleTab = (e: KeyboardEvent) => {
        if (!containerRef.value || e.key !== 'Tab') return

        const focusable = containerRef.value.querySelectorAll<HTMLElement>(
          'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
        )

        if (focusable.length === 0) return

        const first = focusable[0]
        const last = focusable[focusable.length - 1]

        if (e.shiftKey && document.activeElement === first) {
          e.preventDefault()
          last?.focus()
        } else if (!e.shiftKey && document.activeElement === last) {
          e.preventDefault()
          first?.focus()
        }
      }

      return { handleTab }
    }
    ```

    This composable uses VueUse's useMagicKeys for cross-platform keyboard handling.
    DO NOT use manual event listeners (useMagicKeys handles edge cases).
  </action>
  <verify>
    1. File `composables/useKeyboardNavigation.ts` exists
    2. `grep "export function" composables/useKeyboardNavigation.ts` shows three exports
    3. `npm run dev` starts without TypeScript errors
  </verify>
  <done>
    useKeyboardNavigation composable exists with useEscapeKey, useArrowKeys, and useTabTrap utilities
  </done>
</task>

<task type="auto">
  <name>Add keyboard navigation to AppHeader mobile menu</name>
  <files>components/AppHeader.vue</files>
  <action>
    Enhance AppHeader.vue with Escape key to close mobile menu:

    1. Import useEscapeKey from the composable:
       ```typescript
       import { useEscapeKey } from '~/composables/useKeyboardNavigation'
       ```

    2. Add Escape key handler after the existing watch (after line 185):
       ```typescript
       // Close menu on Escape key
       const { escape } = useMagicKeys()
       whenever(escape, () => {
         if (isOpen.value) {
           isOpen.value = false
         }
       })
       ```

    OR use the composable:
       ```typescript
       useEscapeKey(isOpen)
       ```

    3. Ensure the mobile menu button has proper focus management:
       - When menu opens, focus should move to first navigation link
       - When menu closes, focus should return to menu button

    4. Verify the mobile menu has `aria-controls="mobile-menu"` (already present on line 80)
    5. Verify the mobile menu has `id="mobile-menu"` (already present on line 99)

    DO NOT change the existing click handlers or aria-expanded logic.
  </action>
  <verify>
    1. `grep "Escape\|escape" components/AppHeader.vue` shows Escape key handler
    2. `grep "useEscapeKey\|useMagicKeys" components/AppHeader.vue` shows import/usage
    3. `npm run dev` starts without errors
    4. Test: Open mobile menu, press Escape, menu closes
  </verify>
  <done>
    AppHeader mobile menu closes with Escape key, focus returns to menu button
  </done>
</task>

<task type="auto">
  <name>Add keyboard navigation to slider components</name>
  <files>
    components/TestimonialsSlider.vue
    components/ProjectsCarousel.vue
  </files>
  <action>
    Review and enhance slider components with arrow key navigation:

    1. **components/TestimonialsSlider.vue** - Add arrow key navigation:
       - Import useArrowKeys from composable
       - Track current testimonial index
       - Enable ArrowLeft/ArrowRight for navigation
       - Add aria-live region for screen reader announcements
       - Ensure slider container has tabindex="0" to receive keyboard focus

    2. **components/ProjectsCarousel.vue** - Add arrow key navigation:
       - Import useArrowKeys from composable
       - Track current project index
       - Enable ArrowLeft/ArrowRight for navigation
       - Add aria-live region for announcements
       - Ensure proper focus management

    3. **components/HeroSlider.vue** - Already has keyboard navigation (verify it's working)
       - Current implementation uses manual event listeners (lines 376-395)
       - Consider refactoring to use useArrowKeys composable for consistency
       - DO NOT remove existing functionality, just refactor if needed

    Pattern for new sliders:
    ```vue
    <script setup lang="ts">
    import { useArrowKeys } from '~/composables/useKeyboardNavigation'

    const currentIndex = ref(0)
    const items = ref([...])

    useArrowKeys(currentIndex, items.value.length)
    </script>

    <template>
      <div
        class="slider"
        tabindex="0"
        aria-label="Testimonials slider"
      >
        <!-- Slider content -->

        <!-- Live region for screen readers -->
        <div class="sr-only" aria-live="polite">
          Item {{ currentIndex + 1 }} of {{ items.length }}
        </div>
      </div>
    </template>
    ```

    DO NOT add auto-play when keyboard is being used (pause on focus).
  </action>
  <verify>
    1. `grep "useArrowKeys\|useKeyboardNavigation" components/TestimonialsSlider.vue components/ProjectsCarousel.vue` shows imports
    2. `grep "aria-live" components/TestimonialsSlider.vue components/ProjectsCarousel.vue` shows announcements
    3. `grep "tabindex" components/TestimonialsSlider.vue components/ProjectsCarousel.vue` shows keyboard focus
    4. `npm run dev` starts without errors
  </verify>
  <done>
    All slider components support arrow key navigation with screen reader announcements
  </done>
</task>

</tasks>

<verification>
After all tasks complete, verify:
1. `npm run dev` starts without errors
2. Tab through page - logical order is maintained
3. Press Escape on mobile menu - menu closes
4. Press Arrow keys on sliders - navigation works
5. No keyboard traps exist (can Tab in and out of all components)
6. DevTools A11y panel shows no keyboard-related violations
</verification>

<success_criteria>
1. Escape key closes mobile menu and returns focus to trigger button
2. Arrow keys navigate all sliders (HeroSlider, TestimonialsSlider, ProjectsCarousel)
3. Tab key follows logical DOM order through all interactive elements
4. Enter key activates all buttons and links
5. All sliders have aria-live regions for screen reader announcements
6. Keyboard-only users can navigate entire site
</success_criteria>

<output>
After completion, create `.planning/phases/17-accessibility-foundation/17-03-SUMMARY.md` with:
- List of components enhanced with keyboard navigation
- Keyboard patterns implemented (Escape, arrows, Tab)
- Any edge cases handled (e.g., pausing autoplay on focus)
- Notes on slider accessibility patterns
</output>
