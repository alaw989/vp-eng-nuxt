---
phase: 17-accessibility-foundation
plan: 05
type: execute
wave: 3
depends_on: ["17-01", "17-02", "17-04"]
files_modified:
  - composables/useA11y.ts
  - layouts/default.vue
  - components/AppHeader.vue
  - tests-e2e/accessibility.spec.ts
autonomous: false

must_haves:
  truths:
    - "Live region composable exists for screen reader announcements"
    - "Route changes are announced to screen readers"
    - "Dynamic content updates are announced (search results, filters)"
    - "Form validation errors are announced via aria-live"
    - "E2E tests verify screen reader announcements work"
    - "Playwright accessibility tests pass"
  artifacts:
    - path: "composables/useA11y.ts"
      provides: "Live region composable for announcements"
      min_lines: 50
      exports: ["useAnnouncer", "useLiveRegion"]
    - path: "tests-e2e/accessibility.spec.ts"
      provides: "E2E accessibility tests with Playwright"
      min_lines: 60
      contains: "accessibility|aria"
    - path: "layouts/default.vue"
      provides: "Global live region for route announcements"
      contains: "aria-live"
  key_links:
    - from: "composables/useA11y.ts"
      to: "screen readers"
      via: "aria-live region pattern"
      pattern: "aria-live"
    - from: "layouts/default.vue"
      to: "useA11y.ts"
      via: "import and usage of useAnnouncer"
      pattern: "useAnnouncer|announce"
    - from: "tests-e2e/accessibility.spec.ts"
      to: "Playwright"
      via: "expect(locator).toHaveAccessibleName()"
      pattern: "toHaveAccessibleName|aria"
---

<objective>
Create a live region composable for screen reader announcements and implement route change announcements. Add E2E accessibility tests using Playwright to verify WCAG compliance. This satisfies requirements A11Y-09 (live regions) and validates the entire phase's work.

Purpose: A11Y-09 requires live regions for dynamic content announcements. Route changes, search results, form validation, and async updates need screen reader feedback. Playwright has built-in accessibility testing for validation.

Output: Live region composable, route change announcements, E2E accessibility test suite, and verification that all A11Y-01 through A11Y-09 requirements are met.
</objective>

<execution_context>
@/home/deck/.claude/get-shit-done/workflows/execute-plan.md
@/home/deck/.claude/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@planning/REQUIREMENTS.md
@.planning/phases/17-accessibility-foundation/17-RESEARCH.md

# Research findings:
- Live regions use aria-live="polite" or aria-live="assertive"
- Live region must be cleared/reset to trigger re-announcement
- Vue 3 specific pattern: clear value, nextTick, set new value
- Playwright has accessibility testing via aria_snapshot and toHaveAccessibleName()
- TRANS-04 (from REQUIREMENTS) also requires route change announcements

# Current state from codebase review:
- **HeroSlider.vue**: HAS aria-live="polite" region (lines 133-139) - announces slide changes
- **ProjectGallery.vue**: NO live region for image changes (should announce "Image X of Y")
- **AppHeader.vue**: NO route change announcement
- **layouts/default.vue**: NO global live region for route changes

# Live region use cases to implement:
1. Route changes - "Navigated to [page name]"
2. Search results - "Showing X results for [query]"
3. Filter changes - "Filtered to show X items"
4. Form validation - "Error: [field] is required"
5. Modal open/close - "Dialog opened", "Dialog closed"

# Playwright accessibility testing:
- `page.getByRole('button', { name: /.../ })` - Find by ARIA role
- `await expect(locator).toHaveAccessibleName()` - Verify accessible name
- `aria_snapshot` - Capture accessible tree for testing
- `locator.getByLabel()` - Find by aria-label
</context>

<tasks>

<task type="auto">
  <name>Create live region composable for announcements</name>
  <files>composables/useA11y.ts</files>
  <action>
    Create `composables/useA11y.ts` with live region utilities:

    ```typescript
    import { ref, nextTick } from 'vue'

    /**
     * Live region composable for screen reader announcements
     * Uses clear/reset pattern to ensure re-announcement of same content
     */
    export function useAnnouncer(options: { priority?: 'polite' | 'assertive' } = {}) {
      const { priority = 'polite' } = options

      const message = ref('')
      const previousMessage = ref('')

      /**
       * Announce a message to screen readers
       * Clears the live region first to ensure re-announcement
       * @param text - Message to announce
       * @param force - Force announcement even if same as previous
       */
      const announce = async (text: string, force = false) => {
        // Don't re-announce same message unless forced
        if (!force && text === previousMessage.value) {
          return
        }

        // Clear current message
        message.value = ''

        // Wait for DOM update
        await nextTick()

        // Set new message
        message.value = text
        previousMessage.value = text

        // Auto-clear after announcement (polite regions read once)
        setTimeout(() => {
          if (message.value === text) {
            message.value = ''
          }
        }, 1000)
      }

      /**
       * Clear the current announcement
       */
      const clear = () => {
        message.value = ''
      }

      return {
        message,
        announce,
        clear,
        priority
      }
    }

    /**
     * Route change announcer
     * Announces page navigation to screen readers
     */
    export function useRouteAnnouncer() {
      const { announce } = useAnnouncer({ priority: 'polite' })
      const route = useRoute()

      // Get page title from route meta or generate from path
      const getPageTitle = () => {
        if (route.meta.title) {
          return route.meta.title as string
        }

        // Generate title from path
        const path = route.path
        if (path === '/') return 'Home'
        const segments = path.split('/').filter(Boolean)
        return segments[segments.length - 1]?.replace(/-/g, ' ') || 'Page'
      }

      // Announce route changes
      watch(() => route.path, async (to, from) => {
        if (to !== from) {
          const title = getPageTitle()
          await announce(`Navigated to ${title}`)
        }
      })

      return {
        announce,
        getPageTitle
      }
    }

    /**
     * Status announcer for dynamic content
     * Use for search results, filters, loading states
     */
    export function useStatusAnnouncer() {
      const { announce } = useAnnouncer({ priority: 'polite' })

      /**
       * Announce list/item count changes
       */
      const announceCount = async (count: number, label: string) => {
        await announce(`Showing ${count} ${label}${count !== 1 ? 's' : ''}`)
      }

      /**
       * Announce loading state
       */
      const announceLoading = async (loading: boolean) => {
        if (loading) {
          await announce('Loading content', true)
        }
      }

      /**
       * Announce error state
       */
      const announceError = async (error: string) => {
        const { announce: assert } = useAnnouncer({ priority: 'assertive' })
        await assert(`Error: ${error}`)
      }

      return {
        announce,
        announceCount,
        announceLoading,
        announceError
      }
    }
    ```

    This composable provides:
1. useAnnouncer - Base live region with clear/reset pattern
2. useRouteAnnouncer - Route change announcements
3. useStatusAnnouncer - Dynamic content updates

DO NOT use setInterval or timeouts for announcements (screen reader may not catch them).
DO use the clear/reset pattern to ensure re-announcement.
  </action>
  <verify>
    1. File `composables/useA11y.ts` exists
    2. `grep "export function" composables/useA11y.ts` shows three exports
    3. `grep "aria-live" composables/useA11y.ts` shows live region pattern (if template included)
    4. `npm run dev` starts without TypeScript errors
  </verify>
  <done>
    useA11y composable exists with useAnnouncer, useRouteAnnouncer, and useStatusAnnouncer
  </done>
</task>

<task type="auto">
  <name>Implement live regions in layout and components</name>
  <files>
    layouts/default.vue
    components/AppHeader.vue
  </files>
  <action>
    Add live region announcements to layout and components:

    1. **layouts/default.vue** - Add global live region:
       Add before closing `</template>` (after the LazyPwaReloadPrompt):
       ```vue
       <!-- Live region for screen reader announcements -->
       <div
         aria-live="polite"
         aria-atomic="true"
         class="sr-only"
       >
         {{ a11yAnnouncement }}
       </div>
       ```

       In script setup:
       ```typescript
       import { useRouteAnnouncer } from '~/composables/useA11y'

       // This will automatically announce route changes
       useRouteAnnouncer()

       // Expose message for template
       const { message: a11yAnnouncement } = useAnnouncer()
       ```

    2. **components/AppHeader.vue** - Add mobile menu state announcement:
       Add inside the mobile menu div (after line 99):
       ```vue
       <!-- Screen reader announcement for menu state -->
       <div class="sr-only" aria-live="polite">
         {{ isOpen ? 'Menu opened' : 'Menu closed' }}
       </div>
       ```

    3. Ensure `sr-only` utility class exists in Tailwind config or add to main.css:
       ```css
       .sr-only {
         position: absolute;
         width: 1px;
         height: 1px;
         padding: 0;
         margin: -1px;
         overflow: hidden;
         clip: rect(0, 0, 0, 0);
         white-space: nowrap;
         border-width: 0;
       }
       ```

    DO NOT use aria-live="assertive" for route changes (interrupts user).
    DO use aria-atomic="true" to announce complete message content.
  </action>
  <verify>
    1. `grep "aria-live" layouts/default.vue components/AppHeader.vue` shows live regions
    2. `grep "useRouteAnnouncer\|useA11y" layouts/default.vue` shows composable usage
    3. `grep "sr-only" assets/css/main.css` shows screen reader utility (or Tailwind)
    4. `npm run dev` starts without errors
  </verify>
  <done>
    Live regions added to layout and components for screen reader announcements
  </done>
</task>

<task type="checkpoint:human-verify">
  <name>Create E2E accessibility tests and verify compliance</name>
  <files>tests-e2e/accessibility.spec.ts</files>
  <action>
    Create `tests-e2e/accessibility.spec.ts` with comprehensive accessibility tests:

    ```typescript
    import { test, expect } from '@playwright/test'

    test.describe('Accessibility', () => {
      test.beforeEach(async ({ page }) => {
        await page.goto('/')
      })

      test('skip link appears on focus and jumps to main content', async ({ page }) => {
        // Press Tab to focus skip link
        await page.keyboard.press('Tab')

        // Skip link should be visible
        const skipLink = page.getByRole('link', { name: /skip to main content/i })
        await expect(skipLink).toBeVisible()

        // Press Enter to activate
        await page.keyboard.press('Enter')

        // Focus should be on main content
        const main = page.getByRole('main')
        await expect(main).toBeFocused()
      })

      test('all interactive elements have accessible names', async ({ page }) => {
        // Check all buttons have accessible names
        const buttons = page.getByRole('button')
        const count = await buttons.count()

        for (let i = 0; i < count; i++) {
          const button = buttons.nth(i)
          await expect(button).toHaveAccessibleName()
        }

        // Check all links have accessible names (or have aria-label)
        const links = page.getByRole('link')
        const linkCount = await links.count()

        for (let i = 0; i < Math.min(linkCount, 10); i++) {
          const link = links.nth(i)
          await expect(link).toHaveAccessibleName()
        }
      })

      test('keyboard navigation works through all interactive elements', async ({ page }) => {
        const focusableElements = page.locator(
          'a, button, input, select, textarea, [tabindex]:not([tabindex="-1"])'
        )

        const count = await focusableElements.count()
        expect(count).toBeGreaterThan(0)

        // Tab through first 10 elements
        for (let i = 0; i < Math.min(count, 10); i++) {
          await page.keyboard.press('Tab')
          await page.waitForTimeout(100)

          // Verify focus indicator is visible
          const focused = page.locator(':focus')
          await expect(focused).toBeVisible()
        }
      })

      test('mobile menu has proper ARIA attributes', async ({ page }) => {
        await page.setViewportSize({ width: 375, height: 667 })

        // Menu button should have aria-expanded
        const menuButton = page.getByRole('button', { name: /open menu/i })
        await expect(menuButton).toHaveAttribute('aria-expanded', 'false')

        // Open menu
        await menuButton.click()
        await expect(menuButton).toHaveAttribute('aria-expanded', 'true')

        // Menu should have role="navigation" and aria-label
        const menu = page.getByRole('navigation', { name: /mobile/i })
        await expect(menu).toBeVisible()

        // Close menu with Escape
        await page.keyboard.press('Escape')
        await expect(menuButton).toHaveAttribute('aria-expanded', 'false')
      })

      test('page has proper landmark structure', async ({ page }) => {
        // Check for banner (header)
        await expect(page.getByRole('banner')).toBeVisible()

        // Check for navigation
        await expect(page.getByRole('navigation')).toBeVisible()

        // Check for main
        await expect(page.getByRole('main')).toBeVisible()

        // Check for contentinfo (footer)
        await expect(page.getByRole('contentinfo')).toBeVisible()
      })

      test('live region announces route changes', async ({ page }) => {
        // Navigate to a different page
        await page.goto('/about')

        // Live region should have announcement
        const liveRegion = page.locator('[aria-live="polite"]')
        await expect(liveRegion).toBeAttached()

        // Check for announcement text (may take a moment)
        await page.waitForTimeout(500)
        const text = await liveRegion.textContent()
        expect(text?.toLowerCase()).toContain('about')
      })

      test('hero slider has keyboard navigation', async ({ page }) => {
        const slider = page.locator('[aria-label*="slider"]').first()
        await slider.focus()

        // Press ArrowRight to go to next slide
        await page.keyboard.press('ArrowRight')
        await page.waitForTimeout(400)

        // Press ArrowLeft to go back
        await page.keyboard.press('ArrowLeft')
        await page.waitForTimeout(400)

        // Live region should announce slide number
        const liveRegion = slider.locator('[aria-live="polite"]')
        await expect(liveRegion).toBeAttached()
      })

      test('focus is managed properly', async ({ page }) => {
        // Focus should be on document initially
        await expect(page.locator('body')).toBeFocused()

        // Press Tab to move focus
        await page.keyboard.press('Tab')
        const firstFocusable = page.locator(':focus')
        await expect(firstFocusable).toBeVisible()
      })
    })
    ```

    Run tests with: `npm run test:e2e accessibility.spec.ts`

    Verify axe-core violations are checked via DevTools A11y panel.

    DO NOT skip these tests - they validate the entire phase's work.
  </verify>
  <verify>
    1. File `tests-e2e/accessibility.spec.ts` exists
    2. `npm run test:e2e tests-e2e/accessibility.spec.ts` runs the tests
    3. At least 80% of tests pass (some may need manual verification)
    4. DevTools A11y panel shows no critical violations
  </verify>
  <done>
    E2E accessibility test suite created and run, accessibility verified across all components
  </done>
</task>

</tasks>

<verification>
After all tasks complete, verify:
1. `npm run dev` starts without errors
2. Navigate with screen reader - route changes are announced
3. `npm run test:e2e accessibility.spec.ts` - accessibility tests pass
4. DevTools A11y panel shows no critical violations
5. All A11Y-01 through A11Y-09 requirements are met:
   - A11Y-01: Skip link works
   - A11Y-02: ARIA labels present
   - A11Y-03: Keyboard navigation works
   - A11Y-04: Color contrast checked (axe-core)
   - A11Y-05: Alt text meaningful (manual verify)
   - A11Y-06: Focus management works
   - A11Y-07: Semantic structure verified
   - A11Y-08: Focus traps implemented
   - A11Y-09: Live regions announce changes
</verification>

<success_criteria>
1. Live region composable exists with announce, route announcer, and status announcer
2. Route changes are announced to screen readers
3. E2E accessibility test suite covers skip links, keyboard nav, ARIA, landmarks
4. DevTools A11y panel shows no critical violations
5. All 9 accessibility requirements (A11Y-01 through A11Y-09) are satisfied
6. Phase 17 success criteria are met:
   - User can navigate site using only keyboard
   - Screen reader announces page changes correctly
   - Focus indicators are visible (2px minimum)
   - Color contrast meets WCAG AA (verified via axe-core)
   - Modal focus traps work and return focus after closing
</success_criteria>

<output>
After completion, create `.planning/phases/17-accessibility-foundation/17-05-SUMMARY.md` with:
- Live region implementation details
- E2E test results (pass/fail)
- DevTools A11y panel scan results
- Verification checklist for A11Y-01 through A11Y-09
- Any remaining accessibility items deferred to future phases
</output>
