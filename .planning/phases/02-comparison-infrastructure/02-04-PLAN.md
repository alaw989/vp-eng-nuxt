---
phase: 02-comparison-infrastructure
plan: 04
type: execute
wave: 3
depends_on: ["02-01", "02-02"]
files_modified:
  - package.json
  - package-lock.json
  - .planning/scripts/start-viewer.ts
  - .planning/comparison-viewer/ (tested)
autonomous: true

must_haves:
  truths:
    - "Web browser opens automatically to comparison viewer"
    - "Viewer displays side-by-side baseline and current screenshots"
    - "User can switch between mobile/tablet/desktop viewports"
    - "User can select different pages from dropdown"
    - "Pixel diff overlay is visible for comparison"
  artifacts:
    - path: ".planning/scripts/start-viewer.ts"
      provides: "Express server with auto-browser launch"
      min_lines: 40
    - path: "package.json"
      provides: "express dependency for web server"
      contains: "express"
  key_links:
    - from: ".planning/scripts/start-viewer.ts"
      to: ".planning/comparisons/"
      via: "express.static middleware serves comparison images"
      pattern: "express\\.static"
    - from: ".planning/scripts/start-viewer.ts"
      to: ".planning/comparison-viewer/"
      via: "express.static serves viewer HTML/CSS/JS"
      pattern: "comparison-viewer"
    - from: ".planning/comparison-viewer/viewer.js"
      to: ".planning/comparisons/*/comparison.json"
      via: "fetch API loads comparison metadata"
      pattern: "comparison\\.json"
    - from: ".planning/scripts/start-viewer.ts"
      to: "browser"
      via: "open package launches default browser"
      pattern: "from.*open"
---

<objective>
Wire the viewer UI to comparison data via Express server, enabling full end-to-end visual comparison functionality.

Purpose: Connect the static UI files (from 02-02) with the comparison data (from 02-01) through a local Express server. The viewer becomes a fully functional tool for reviewing visual regression results.

Output: Working web viewer that auto-opens in browser displaying comparison results.
</objective>

<execution_context>
@/home/deck/.claude/get-shit-done/workflows/execute-plan.md
@/home/deck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-comparison-infrastructure/02-CONTEXT.md
@.planning/phases/02-comparison-infrastructure/02-RESEARCH.md

# Plan 02-01 provides comparison images this viewer consumes
@.planning/phases/02-comparison-infrastructure/02-01-SUMMARY.md

# Plan 02-02 provides viewer UI files this server serves
@.planning/phases/02-comparison-infrastructure/02-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Express server dependency</name>
  <files>package.json, package-lock.json</files>
  <action>
    Install Express for serving the comparison viewer:
    Run: npm install --save-dev express

    Express will serve:
    1. Comparison images from .planning/comparisons/
    2. Viewer UI files from .planning/comparison-viewer/
    3. API endpoint for listing available comparisons

    The 'open' package is already installed from plan 02-01.
  </action>
  <verify>grep -q "express" package.json</verify>
  <done>Express installed as dev dependency</done>
</task>

<task type="auto">
  <name>Task 2: Create Express server with auto-open</name>
  <files>.planning/scripts/start-viewer.ts</files>
  <action>
    Create .planning/scripts/start-viewer.ts that:

    1. Imports express, open, path, fs
    2. Creates Express app on port 4321
    3. Serves static files:
       - /comparisons -> .planning/comparisons
       - / -> .planning/comparison-viewer
    4. API endpoint GET /api/comparisons:
       - Lists all timestamped directories in comparisons/
       - Returns array of { timestamp, path }
    5. API endpoint GET /api/comparisons/latest:
       - Finds most recent comparison directory
       - Returns { timestamp, comparison.json contents }
    6. Starts server and logs URL
    7. Auto-opens browser to http://localhost:4321 using `open` package

    Handle EADDRINUSE gracefully (port already in use).
    Include graceful shutdown on SIGINT.
  </action>
  <verify>test -f .planning/scripts/start-viewer.ts && grep -q "express" .planning/scripts/start-viewer.ts && grep -q "open(" .planning/scripts/start-viewer.ts</verify>
  <done>Express server script with auto-browser launch</done>
</task>

<task type="auto">
  <name>Task 3: Test viewer startup and verify functionality</name>
  <files>.planning/comparison-viewer/</files>
  <action>
    Test the comparison viewer:
    1. Ensure comparison exists from 02-01 (run generate-comparison.ts if needed)
    2. Verify viewer UI files exist from 02-02
    3. Start viewer: npx tsx .planning/scripts/start-viewer.ts
    4. Verify browser opens to localhost:4321
    5. Test all controls:
       - Page dropdown switches between pages
       - Viewport tabs switch between mobile/tablet/desktop
       - All three images (baseline, current, diff) load
       - Diff statistics display correctly
    6. Test independent scrolling (each image scrolls separately)
    7. Kill server with Ctrl+C

    Manual verification: The viewer should load without console errors and display comparison images.
  </action>
  <verify>curl -s http://localhost:4321/api/comparisons | head -1</verify>
  <done>Viewer starts, browser opens, all controls work correctly</done>
</task>

</tasks>

<verification>
After completion, verify:
- [ ] Express is installed in package.json
- [ ] start-viewer.ts creates Express server on port 4321
- [ ] Running start-viewer.ts auto-opens browser
- [ ] API endpoints return valid comparison data
- [ ] Page selector switches images
- [ ] Viewport tabs switch between mobile/tablet/desktop
- [ ] All three image columns display correctly
- [ ] Independent scrolling works per CONTEXT.md decision
</verification>

<success_criteria>
1. Running `npx tsx .planning/scripts/start-viewer.ts` starts web server and opens browser
2. Viewer displays baseline, current, and diff images side-by-side
3. User can navigate between pages and viewports
4. Diff statistics are visible
5. Full end-to-end comparison viewing workflow is functional
</success_criteria>

<output>
After completion, create `.planning/phases/02-comparison-infrastructure/02-04-SUMMARY.md`

Include in SUMMARY:
- Viewer URL (http://localhost:4321)
- Confirmation that UI (02-02) is properly wired to data (02-01)
- Any integration adjustments made
</output>
