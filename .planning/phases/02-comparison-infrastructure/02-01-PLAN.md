---
phase: 02-comparison-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - package-lock.json
  - .planning/scripts/generate-comparison.ts
  - .planning/comparisons/
autonomous: true

must_haves:
  truths:
    - "Current Nuxt site screenshots captured at same viewports as baselines"
    - "Pixel diff images generated highlighting differences from baseline"
    - "Diff images saved to timestamped directory for historical tracking"
    - "Comparison script can be re-run on-demand"
  artifacts:
    - path: ".planning/scripts/generate-comparison.ts"
      provides: "Screenshot capture and pixel diff generation"
      min_lines: 80
    - path: ".planning/comparisons/YYYY-MM-DD_HH-mm-ss/"
      provides: "Timestamped comparison results"
      contains: ["comparison.json", "mobile/", "tablet/", "desktop/"]
    - path: "package.json"
      provides: "odiff-bin dependency"
      contains: "odiff-bin"
  key_links:
    - from: ".planning/scripts/generate-comparison.ts"
      to: ".planning/audit/baselines/"
      via: "File path reference to baseline images"
      pattern: "baselines/.*\\.png"
    - from: ".planning/scripts/generate-comparison.ts"
      to: "http://localhost:3000"
      via: "Playwright navigates to local Nuxt dev server"
      pattern: "localhost:3000"
    - from: ".planning/scripts/generate-comparison.ts"
      to: "odiff-bin"
      via: "import compare from odiff-bin"
      pattern: "from.*odiff-bin"
---

<objective>
Build the pixel-level comparison infrastructure that enables visual regression testing between baseline screenshots (old site) and current implementation (new Nuxt site).

Purpose: Establish automated visual diff capability to catch unintended regressions during development. The pixel diff overlay shows exactly what changed between the old and new implementations.

Output: Executable script that captures current screenshots and generates pixel diff overlays using ODiff.
</objective>

<execution_context>
@/home/deck/.claude/get-shit-done/workflows/execute-plan.md
@/home/deck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-comparison-infrastructure/02-CONTEXT.md
@.planning/phases/02-comparison-infrastructure/02-RESEARCH.md
@.planning/audit/pages.json
@.planning/audit/baselines/metadata.json

# Phase 1 Summary references (relevant for baseline location structure)
@.planning/phases/01-audit-baseline-capture/01-01-SUMMARY.md
@.planning/phases/01-audit-baseline-capture/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install pixel diff dependencies</name>
  <files>package.json, package-lock.json</files>
  <action>
    Install required packages for pixel diff generation:
    - odiff-bin (ultra-fast pixel comparison with SIMD)
    - open (cross-platform browser launcher for auto-opening viewer)

    Run: npm install --save-dev odiff-bin open

    Do NOT install express or pngjs yet - those are for other plans (02-02).
  </action>
  <verify>grep -q "odiff-bin" package.json && grep -q "open" package.json</verify>
  <done>odiff-bin and open packages installed as dev dependencies</done>
</task>

<task type="auto">
  <name>Task 2: Create current screenshot capture and pixel diff script</name>
  <files>.planning/scripts/generate-comparison.ts</files>
  <action>
    Create .planning/scripts/generate-comparison.ts that:

    1. Reads .planning/audit/pages.json for page list
    2. Starts local Nuxt dev server on port 3000 if not running
    3. Uses Playwright (already installed) to capture current screenshots at:
       - mobile: 375x812
       - tablet: 768x1024
       - desktop: 1920x1080
    4. Saves current screenshots to timestamped directory: .planning/comparisons/{timestamp}/{page}/
    5. Copies baseline screenshots from .planning/audit/baselines/ to comparison directory
    6. Uses odiff-bin's ODiffServer to generate pixel diffs:
       - threshold: 0.1 (10% color difference)
       - diffColor: '#cd2cc9' (magenta)
       - antialiasing: true
       - failOnLayoutDiff: false
    7. Creates comparison.json metadata with:
       - timestamp, page count, viewport info
       - per-page results: match status, diffCount, diffPercentage
    8. Outputs summary to console

    Viewport configuration MUST match Phase 1 baselines exactly.

    Use ODiffServer pattern for batch processing (faster than spawning processes).

    Handle errors gracefully: capture failures logged but don't stop entire run.
  </action>
  <verify>test -f .planning/scripts/generate-comparison.ts && grep -q "odiff-bin" .planning/scripts/generate-comparison.ts</verify>
  <done>Script exists with Playwright capture and odiff-bin diff generation</done>
</task>

<task type="auto">
  <name>Task 3: Run initial comparison and verify output</name>
  <files>.planning/comparisons/</files>
  <action>
    Execute the comparison script:
    1. Start Nuxt dev server in background: npm run dev &
    2. Wait for server to be ready (port 3000 listening)
    3. Run: npx tsx .planning/scripts/generate-comparison.ts
    4. Verify output directory structure created
    5. Check that comparison.json contains metadata
    6. Verify diff.png files exist for each page/viewport combination

    Expected behavior: diffs will be significant since new implementation differs visually from old site. This is expected - we're building the tool, not expecting visual parity yet.
  </action>
  <verify>test -d .planning/comparisons && ls -d .planning/comparisons/*/ && test -f .planning/comparisons/*/comparison.json</verify>
  <done>Comparison directory created with current screenshots, baselines, and pixel diffs</done>
</task>

</tasks>

<verification>
After completion, verify:
- [ ] package.json contains odiff-bin and open dependencies
- [ ] generate-comparison.ts script is executable with npx tsx
- [ ] Comparison directory has timestamped subdirectory
- [ ] Each page has mobile.png, tablet.png, desktop.png (current)
- [ ] Each page has baseline-{viewport}.png (copied from audit)
- [ ] Each page has diff-{viewport}.png (generated by odiff)
- [ ] comparison.json contains match status and diff metrics for all pages
</verification>

<success_criteria>
1. Running `npx tsx .planning/scripts/generate-comparison.ts` produces a timestamped comparison directory
2. Comparison directory contains current screenshots, copied baselines, and generated pixel diffs
3. comparison.json provides structured metadata for consumption by web viewer (02-02)
4. Script is idempotent - can be re-run to create new comparison snapshots
</success_criteria>

<output>
After completion, create `.planning/phases/02-comparison-infrastructure/02-01-SUMMARY.md`

Include in SUMMARY:
- Number of pages compared
- Total diff percentage (expected to be high for initial run)
- Comparison directory path
- Any pages that failed to capture or compare
</output>
