---
phase: 02-comparison-infrastructure
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - .planning/comparison-viewer/index.html
  - .planning/comparison-viewer/viewer.css
  - .planning/comparison-viewer/viewer.js
  - .planning/scripts/start-viewer.ts
autonomous: true

must_haves:
  truths:
    - "Web browser opens automatically to comparison viewer"
    - "Viewer displays side-by-side baseline and current screenshots"
    - "User can switch between mobile/tablet/desktop viewports"
    - "User can select different pages from dropdown"
    - "Pixel diff overlay is visible for comparison"
  artifacts:
    - path: ".planning/comparison-viewer/index.html"
      provides: "Main viewer UI with side-by-side image layout"
      min_lines: 40
    - path: ".planning/comparison-viewer/viewer.css"
      provides: "Viewer styling with responsive layout"
      min_lines: 30
    - path: ".planning/comparison-viewer/viewer.js"
      provides: "Client-side comparison logic (viewport switching, page selection)"
      min_lines: 60
    - path: ".planning/scripts/start-viewer.ts"
      provides: "Express server with auto-browser launch"
      min_lines: 40
    - path: "package.json"
      provides: "express dependency for web server"
      contains: "express"
  key_links:
    - from: ".planning/scripts/start-viewer.ts"
      to: ".planning/comparisons/"
      via: "express.static middleware serves comparison images"
      pattern: "express\\.static"
    - from: ".planning/scripts/start-viewer.ts"
      to: ".planning/comparison-viewer/"
      via: "express.static serves viewer HTML/CSS/JS"
      pattern: "comparison-viewer"
    - from: ".planning/comparison-viewer/viewer.js"
      to: ".planning/comparisons/*/comparison.json"
      via: "fetch API loads comparison metadata"
      pattern: "comparison\\.json"
    - from: ".planning/scripts/start-viewer.ts"
      to: "browser"
      via: "open package launches default browser"
      pattern: "from.*open"
---

<objective>
Create a web-based visual comparison viewer that displays baseline, current, and diff images side-by-side with interactive controls.

Purpose: Provide an intuitive browser-based interface for reviewing visual regression test results. The viewer enables quick visual verification of changes between old and new implementations.

Output: Interactive web viewer that auto-opens in browser displaying comparison results.
</objective>

<execution_context>
@/home/deck/.claude/get-shit-done/workflows/execute-plan.md
@/home/deck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-comparison-infrastructure/02-CONTEXT.md
@.planning/phases/02-comparison-infrastructure/02-RESEARCH.md

# Plan 02-01 provides comparison images this viewer consumes
@.planning/phases/02-comparison-infrastructure/02-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Express server dependency</name>
  <files>package.json, package-lock.json</files>
  <action>
    Install Express for serving the comparison viewer:
    Run: npm install --save-dev express

    Express will serve:
    1. Comparison images from .planning/comparisons/
    2. Viewer UI files from .planning/comparison-viewer/
    3. API endpoint for listing available comparisons
  </action>
  <verify>grep -q "express" package.json</verify>
  <done>Express installed as dev dependency</done>
</task>

<task type="auto">
  <name>Task 2: Create viewer HTML structure</name>
  <files>.planning/comparison-viewer/index.html</files>
  <action>
    Create .planning/comparison-viewer/index.html with:

    1. Header with title "VP Associates - Visual Comparison Viewer"
    2. Controls section:
       - Page selector dropdown (populated from comparison.json)
       - Viewport tabs: Mobile | Tablet | Desktop
       - Comparison run selector (for historical comparisons)
    3. Main image display area with three columns:
       - "Baseline" (old site)
       - "Current" (new implementation)
       - "Diff" (pixel differences highlighted)
    4. Each column has:
       - Image element
       - Label showing page/viewport
       - Independent scrolling (per CONTEXT.md decision)
    5. Footer with diff statistics (diff percentage, pixel count)

    Use semantic HTML5: header, main, section, footer.
    Link to viewer.css and viewer.js.
  </action>
  <verify>test -f .planning/comparison-viewer/index.html && grep -q "<img" .planning/comparison-viewer/index.html</verify>
  <done>HTML structure with side-by-side layout and controls</done>
</task>

<task type="auto">
  <name>Task 3: Create viewer CSS styling</name>
  <files>.planning/comparison-viewer/viewer.css</files>
  <action>
    Create .planning/comparison-viewer/viewer.css with:

    1. Modern, clean styling using CSS custom properties
    2. Responsive grid layout for three image columns
    3. Viewport tabs with active state styling
    4. Image containers with:
       - Max-width 100% to prevent overflow
       - Box shadow for depth
       - Border radius
       - Light background for diff visibility
    5. Controls section with:
       - Flexbox layout for controls
       - Styled dropdown and tabs
       - Hover states for interactivity
    6. Mobile-friendly: columns stack vertically on small screens

    Use a neutral color scheme (grays, white) to let images stand out.
    Diff images should be clearly distinguishable (magenta highlights).
  </action>
  <verify>test -f .planning/comparison-viewer/viewer.css && grep -q "grid\\|flex" .planning/comparison-viewer/viewer.css</verify>
  <done>CSS with responsive layout and control styling</done>
</task>

<task type="auto">
  <name>Task 4: Create viewer JavaScript logic</name>
  <files>.planning/comparison-viewer/viewer.js</files>
  <action>
    Create .planning/comparison-viewer/viewer.js with:

    1. State management:
       - currentPage (default: first page)
       - currentViewport (default: mobile)
       - currentComparison (default: latest timestamp)

    2. Functions:
       - loadComparisonList(): fetch available comparison runs
       - loadComparison(timestamp): load comparison.json metadata
       - updateImages(): update img src based on current selections
       - updateStats(): display diff percentage and pixel count

    3. Event listeners:
       - Page dropdown change: update currentPage, refresh images
       - Viewport tab click: update currentViewport, refresh images
       - Comparison selector change: load different historical comparison

    4. Image paths constructed as:
       - /comparisons/{timestamp}/{page}/{viewport}.png (current)
       - /comparisons/{timestamp}/{page}/baseline-{viewport}.png
       - /comparisons/{timestamp}/{page}/diff-{viewport}.png

    5. Error handling: show placeholder if image fails to load

    Initialize on DOMContentLoaded with latest comparison loaded.
  </action>
  <verify>test -f .planning/comparison-viewer/viewer.js && grep -q "fetch\\|addEventListener" .planning/comparison-viewer/viewer.js</verify>
  <done>JavaScript with comparison loading and image update logic</done>
</task>

<task type="auto">
  <name>Task 5: Create Express server with auto-open</name>
  <files>.planning/scripts/start-viewer.ts</files>
  <action>
    Create .planning/scripts/start-viewer.ts that:

    1. Imports express, open, path, fs
    2. Creates Express app on port 4321
    3. Serves static files:
       - /comparisons -> .planning/comparisons
       - / -> .planning/comparison-viewer
    4. API endpoint GET /api/comparisons:
       - Lists all timestamped directories in comparisons/
       - Returns array of { timestamp, path }
    5. API endpoint GET /api/comparisons/latest:
       - Finds most recent comparison directory
       - Returns { timestamp, comparison.json contents }
    6. Starts server and logs URL
    7. Auto-opens browser to http://localhost:4321 using `open` package

    Handle EADDRINUSE gracefully (port already in use).
    Include graceful shutdown on SIGINT.
  </action>
  <verify>test -f .planning/scripts/start-viewer.ts && grep -q "express" .planning/scripts/start-viewer.ts && grep -q "open(" .planning/scripts/start-viewer.ts</verify>
  <done>Express server script with auto-browser launch</done>
</task>

<task type="auto">
  <name>Task 6: Test viewer startup and verify functionality</name>
  <files>.planning/comparison-viewer/</files>
  <action>
    Test the comparison viewer:
    1. Ensure comparison exists from 02-01 (run 02-01 script if needed)
    2. Start viewer: npx tsx .planning/scripts/start-viewer.ts
    3. Verify browser opens to localhost:4321
    4. Test all controls:
       - Page dropdown switches between pages
       - Viewport tabs switch between mobile/tablet/desktop
       - All three images (baseline, current, diff) load
       - Diff statistics display correctly
    5. Test independent scrolling (each image scrolls separately)
    6. Kill server with Ctrl+C

    Manual verification: The viewer should load without console errors.
  </action>
  <verify>curl -s http://localhost:4321/api/comparisons | head -1</verify>
  <done>Viewer starts, browser opens, all controls work correctly</done>
</task>

</tasks>

<verification>
After completion, verify:
- [ ] Express is installed in package.json
- [ ] index.html has side-by-side three-column layout
- [ ] viewer.css has responsive grid and control styling
- [ ] viewer.js has comparison loading and event handling
- [ ] start-viewer.ts creates Express server on port 4321
- [ ] Running start-viewer.ts auto-opens browser
- [ ] Page selector switches images
- [ ] Viewport tabs switch between mobile/tablet/desktop
- [ ] All three image columns display correctly
</verification>

<success_criteria>
1. Running `npx tsx .planning/scripts/start-viewer.ts` starts web server and opens browser
2. Viewer displays baseline, current, and diff images side-by-side
3. User can navigate between pages and viewports
4. Diff statistics are visible
5. Independent scrolling works per CONTEXT.md decision
</success_criteria>

<output>
After completion, create `.planning/phases/02-comparison-infrastructure/02-02-SUMMARY.md`

Include in SUMMARY:
- Viewer URL (http://localhost:4321)
- List of interactive controls implemented
- Any styling decisions made (at Claude's discretion per CONTEXT.md)
</output>
