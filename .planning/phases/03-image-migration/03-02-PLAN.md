---
phase: 03-image-migration
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - .planning/scripts/optimize-images.ts
  - public/images/
autonomous: true

must_haves:
  truths:
    - "All raw images converted to WebP format with quality 80%"
    - "JPG fallback files generated for each image"
    - "Three responsive variants generated per image (640w, 1280w, 1920w)"
    - "Images organized by type (hero/, projects/, team/, services/, shared/)"
    - "File sizes meet targets (hero <200KB, project <100KB, team <50KB)"
    - "Images resized to max 1920px width preserving aspect ratio"
  artifacts:
    - path: ".planning/scripts/optimize-images.ts"
      provides: "Image optimization pipeline with Sharp"
      min_lines: 250
      exports: ["optimizeImages", "generateVariants", "categorizeImage"]
    - path: "public/images/hero/"
      provides: "Optimized hero/background images with responsive variants"
    - path: "public/images/projects/"
      provides: "Optimized project images with responsive variants"
    - path: "public/images/team/"
      provides: "Optimized team headshots with responsive variants"
    - path: "public/images/shared/"
      provides: "Deduplicated shared images with context prefixes"
  key_links:
    - from: ".planning/scripts/optimize-images.ts"
      to: ".planning/audit/raw-images.json"
      via: "Import raw images catalog for processing"
      pattern: "raw-images.json"
    - from: ".planning/scripts/optimize-images.ts"
      to: "public/images/"
      via: "Write optimized files to public directory"
      pattern: "public/images/"
---

<objective>
Optimize all downloaded images for web performance. Generate WebP primary format with JPG fallback, create three responsive variants (640w, 1280w, 1920w), organize images by type, and enforce file size caps.

Purpose: Web performance optimization reduces bandwidth usage and improves Core Web Vitals. Responsive variants enable browser-optimized delivery. Format fallbacks ensure browser compatibility.

Output: Optimization script (.planning/scripts/optimize-images.ts), organized optimized images in public/images/, optimization summary catalog
</objective>

<execution_context>
@/home/deck/.claude/get-shit-done/workflows/execute-plan.md
@/home/deck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-image-migration/03-CONTEXT.md
@.planning/phases/03-image-migration/03-RESEARCH.md
@.planning/phases/03-image-migration/03-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Create image optimization script with Sharp pipeline</name>
  <files>.planning/scripts/optimize-images.ts</files>
  <action>
    Create TypeScript script at `.planning/scripts/optimize-images.ts` with the following structure:

    **Imports:**
    - `sharp` for image processing (resize, format conversion)
    - `fs/promises` and `path` for file operations
    - Raw images catalog import

    **Interfaces:**
    ```typescript
    interface OptimizedImageEntry {
      sourceUrl: string;
      hash: string;
      category: string;
      filename: string;
      variants: {
        webp: string[];  // ['image-640w.webp', 'image-1280w.webp', 'image-1920w.webp']
        jpg: string[];   // ['image-640w.jpg', 'image-1280w.jpg', 'image-1920w.jpg']
      };
      sizes: {
        '640w': number;
        '1280w': number;
        '1920w': number;
      };
      metadata: {
        originalWidth: number;
        originalHeight: number;
        format: string;
      };
    }

    interface OptimizationCatalog {
      generated: string;
      images: OptimizedImageEntry[];
      summary: {
        totalImages: number;
        totalVariants: number;
        totalSizeBytes: number;
        byCategory: Record<string, number>;
        oversizedImages: string[];
      };
    }
    ```

    **Functions to implement:**

    1. `categorizeImage(entry: RawImageEntry, filename: string): string`
       - Determine category based on URL path, filename, and image dimensions
       - Rules:
         - Width >= 1920 OR filename contains 'hero' or 'background' → 'hero'
         - Filename contains 'team' or 'avatar' → 'team'
         - Filename contains 'project' or 'portfolio' → 'projects'
         - Filename contains 'service' → 'services'
         - Duplicate detected (hash seen before) → 'shared'
         - Default → 'general'
       - For shared images, add context prefix: `shared-{original-category}-{filename}`

    2. `generateVariants(inputPath: string, outputPath: string, sizes: number[]): Promise<void>`
       - Use Sharp's `clone()` method for parallel variant generation
       - For each size in [640, 1280, 1920]:
         - WebP: `.resize(size, null, { fit: 'inside', withoutEnlargement: true }).webp({ quality: 80 })`
         - JPG: `.resize(size, null, { fit: 'inside', withoutEnlargement: true }).jpeg({ quality: 80 })`
       - Use `Promise.all()` for parallel processing of all 6 variants (3 sizes x 2 formats)

    3. `async optimizeImages(): Promise<OptimizationCatalog>`
       - Load raw images catalog from `.planning/audit/raw-images.json`
       - Track processed hashes for deduplication detection
       - For each raw image:
         - Calculate category
         - Generate descriptive filename from URL or use hash-based name
         - Call generateVariants() to create all outputs
         - Check file sizes against targets:
           - Hero: max 200KB per variant
           - Projects: max 100KB per variant
           - Team: max 50KB per variant
         - Log oversized images for manual review
       - Build output catalog with all variants and metadata

    **File organization:**
    - Create directories: `public/images/hero/`, `public/images/projects/`, `public/images/team/`, `public/images/services/`, `public/images/shared/`, `public/images/general/`
    - Filename pattern: `{basename}-{size}w.{ext}`
    - Examples: `hero-home-640w.webp`, `project-bridge-1280w.webp`, `shared-hero-home-1920w.webp`

    **Quality targets:**
    - WebP quality: 80
    - JPG quality: 80
    - Resize: max 1920px width, `fit: 'inside'`, `withoutEnlargement: true`
    - Auto-orient: call `.rotate()` before resize to handle EXIF orientation

    **Main execution:**
    - Call `optimizeImages()`
    - Write catalog to `.planning/audit/optimized-images.json`
    - Log summary (total images, total variants, oversized warnings)

    **Important:**
    - Use `sharp.clone()` for efficient multi-variant generation
    - Apply EXIF auto-orientation before resize
    - Track and report images that exceed size targets
    - Preserve original aspect ratio with `fit: 'inside'`
    - Don't enlarge smaller images with `withoutEnlargement: true`
  </action>
  <verify>`npx tsx .planning/scripts/optimize-images.ts` completes without errors and creates .planning/audit/optimized-images.json</verify>
  <done>Script runs successfully, generates all WebP/JPG variants, organizes by category</done>
</task>

<task type="auto">
  <name>Execute optimization and verify file size targets</name>
  <files>public/images/, .planning/audit/optimized-images.json</files>
  <action>
    Run the optimization script:
    ```bash
    npx tsx .planning/scripts/optimize-images.ts
    ```

    After completion, verify:
    1. All category directories exist in `public/images/`
    2. Each image has 6 files (3 sizes x 2 formats)
    3. File sizes meet targets (check optimized-images.json summary)
    4. Oversized images are logged for review

    Check file sizes:
    ```bash
    # Verify files exist and check sizes
    find public/images -name "*.webp" -o -name "*.jpg" | head -20
    du -sh public/images/*/
    ```

    If any images exceed size targets, log them but DO NOT reprocess in this task (document for potential quality adjustment).
  </action>
  <verify>At least 30 total variant files exist (based on expected ~10+ raw images), categorized properly</verify>
  <done>All images optimized with WebP+JPG variants, organized by type, file sizes documented</done>
</task>

</tasks>

<verification>
After completion, verify:
1. Optimization script exists and runs without errors
2. `public/images/` contains category subdirectories (hero/, projects/, team/, services/, shared/, general/)
3. Each image has 6 variant files (e.g., `name-640w.webp`, `name-640w.jpg`, `name-1280w.webp`, `name-1280w.jpg`, `name-1920w.webp`, `name-1920w.jpg`)
4. `.planning/audit/optimized-images.json` exists with complete catalog
5. File sizes are within targets (check summary.over oversizedImages array)
6. Images maintain aspect ratios (verify visually if needed)

Run: `cat .planning/audit/optimized-images.json | jq '.summary'` to view optimization statistics
</verification>

<success_criteria>
1. Script `.planning/scripts/optimize-images.ts` exists and executes successfully
2. All raw images from 03-01 are processed (check image counts match)
3. WebP and JPG variants generated for all images at 3 sizes
4. Images organized into appropriate category directories
5. Optimization catalog documents all variants with file sizes
6. No more than 10% of variants exceed size targets (acceptable threshold)
</success_criteria>

<output>
After completion, create `.planning/phases/03-image-migration/03-02-SUMMARY.md` with:
- Total images optimized
- Total variants generated (should be images x 6)
- Total size of optimized images vs raw images
- Breakdown by category
- List of any images exceeding size targets
- Disk space savings percentage
</output>
