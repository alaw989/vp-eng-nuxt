---
phase: 03-image-migration
plan: 03
type: execute
wave: 3
depends_on: ["03-01", "03-02"]
files_modified:
  - public/images/image-mapping.json
  - .planning/audit/image-mapping.json
autonomous: true

must_haves:
  truths:
    - "Source URL to local path mapping documented for all images"
    - "Mapping file includes both WebP and JPG variant paths"
    - "All three responsive sizes documented (640w, 1280w, 1920w)"
    - "Duplicate images reference shared location with context prefix"
    - "Category assignments documented for easy lookup"
    - "Mapping file can be used for reference during component updates"
  artifacts:
    - path: "public/images/image-mapping.json"
      provides: "Source URL to local path mapping for component development"
      contains: "[{\"sourceUrl\",\"localPath\",\"variants\",\"category\""
    - path: ".planning/audit/image-mapping.json"
      provides: "Complete audit record of image migration"
      contains: "\"generated\",\"sourceUrl\",\"images\""
  key_links:
    - from: "public/images/image-mapping.json"
      to: ".planning/audit/optimized-images.json"
      via: "Import and transform optimization data"
      pattern: "optimized-images.json"
    - from: "public/images/image-mapping.json"
      to: "components/"
      via: "Used by developers to find image paths when updating components"
      pattern: "image-mapping.json"
---

<objective>
Generate a comprehensive image mapping file that documents the relationship between source URLs on vp-associates.com and local optimized image paths. Include all variant information, category assignments, and duplicate references for easy lookup during component development.

Purpose: The mapping file serves as the reference document for developers updating components to use migrated images. Without it, finding the correct local path for a source image requires manual file system browsing.

Output: Mapping files at both `public/images/image-mapping.json` (developer reference) and `.planning/audit/image-mapping.json` (audit record)
</objective>

<execution_context>
@/home/deck/.claude/get-shit-done/workflows/execute-plan.md
@/home/deck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-image-migration/03-CONTEXT.md
@.planning/phases/03-image-migration/03-RESEARCH.md
@.planning/phases/03-image-migration/03-01-SUMMARY.md
@.planning/phases/03-image-migration/03-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Create image mapping generation script</name>
  <files>.planning/scripts/generate-mapping.ts</files>
  <action>
    Create TypeScript script at `.planning/scripts/generate-mapping.ts` with the following structure:

    **Imports:**
    - `fs/promises` and `path` for file operations
    - Optimized images catalog import

    **Interfaces:**
    ```typescript
    interface MappingEntry {
      sourceUrl: string;
      category: string;
      basePath: string;
      filename: string;
      isDuplicate: boolean;
      sharedWith?: string[];
      variants: {
        webp: {
          small: string;    // /images/hero/image-640w.webp
          medium: string;   // /images/hero/image-1280w.webp
          large: string;    // /images/hero/image-1920w.webp
        };
        jpg: {
          small: string;
          medium: string;
          large: string;
        };
      };
      srcset: {
        webp: string;  // "/images/hero/image-640w.webp 640w, /images/hero/image-1280w.webp 1280w, ..."
        jpg: string;
      };
      metadata: {
        originalFormat: string;
        originalSize: number;
        optimizedSize: number;
        compressionRatio: number;
      };
    }

    interface ImageMapping {
      generated: string;
      sourceUrl: string;
      images: MappingEntry[];
      summary: {
        totalImages: number;
        byCategory: Record<string, number>;
        duplicateCount: number;
        totalVariants: number;
      };
      usageGuide: {
        description: string;
        srcsetExample: string;
        nuxtImageExample: string;
      };
    }
    ```

    **Functions to implement:**

    1. `buildMappingEntry(optimizedEntry: OptimizedImageEntry, isDuplicate: boolean, sharedWith?: string[]): MappingEntry`
       - Transform optimized entry to mapping entry format
       - Build absolute paths for all variants (e.g., `/images/hero/image-640w.webp`)
       - Generate srcset strings for easy copy-paste into components
       - Calculate compression ratio
       - Mark duplicates and list what other source URLs share this image

    2. `generateSrcset(basePath: string, filename: string, sizes: number[], format: 'webp' | 'jpg'): string`
       - Build srcset string: `/images/category/file-640w.webp 640w, /images/category/file-1280w.webp 1280w, /images/category/file-1920w.webp 1920w`

    3. `async generateMapping(): Promise<ImageMapping>`
       - Load optimized images catalog from `.planning/audit/optimized-images.json`
       - Build hash-based lookup to detect duplicates
       - For each optimized image:
         - Check if hash exists in lookup (duplicate detection)
         - Build mapping entry with variant paths
         - Generate srcset strings for both formats
         - Track category counts and duplicate stats
       - Build usage guide with Nuxt Image component examples

    **Output format:**
    The mapping file should be easy to read and use. Include:
    - Source URL for lookup
    - Local paths for all variants
    - Ready-to-use srcset strings
    - Nuxt Image component example code
    - Duplicate references

    **Usage guide section:**
    ```json
    "usageGuide": {
      "description": "Use the srcset strings directly in img srcset attributes, or copy local paths into NuxtImage components",
      "srcsetExample": "<img srcset=\"/images/hero/home-640w.webp 640w, /images/hero/home-1280w.webp 1280w, /images/hero/home-1920w.webp 1920w\" src=\"/images/hero/home-640w.webp\" alt=\"Description\">",
      "nuxtImageExample": "<NuxtImg src=\"/images/hero/home.webp\" width=\"1920\" height=\"1080\" format=\"webp\" />"
    }
    ```

    **Main execution:**
    - Call `generateMapping()`
    - Write to both `public/images/image-mapping.json` and `.planning/audit/image-mapping.json`
    - Log summary statistics

    **Important:**
    - Use forward slashes in all paths (web-compatible)
    - Paths should be relative to `public/` directory (start with `/images/`)
    - Include usage guide for developer convenience
    - Document all duplicates with their source URLs
  </action>
  <verify>`npx tsx .planning/scripts/generate-mapping.ts` completes without errors and creates both mapping files</verify>
  <done>Script runs successfully, generates complete mapping with srcset strings and usage examples</done>
</task>

<task type="auto">
  <name>Execute mapping generation and validate output</name>
  <files>public/images/image-mapping.json, .planning/audit/image-mapping.json</files>
  <action>
    Run the mapping generation script:
    ```bash
    npx tsx .planning/scripts/generate-mapping.ts
    ```

    After completion, verify:
    1. Both mapping files exist and contain valid JSON
    2. File counts match optimized-images.json
    3. All variant paths reference existing files
    4. Srcset strings are properly formatted
    5. Usage guide is present and helpful

    Validate paths:
    ```bash
    # Check a few paths exist
    cat public/images/image-mapping.json | jq '.images[0].variants.webp.large' | xargs ls -la public/images/
    ```

    Verify duplicates section:
    ```bash
    cat .planning/audit/image-mapping.json | jq '.summary.duplicateCount'
    ```
  </action>
  <verify>Mapping file contains entries for all optimized images, all paths reference existing files</verify>
  <done>Complete image mapping generated and validated, ready for developer use</done>
</task>

<task type="auto">
  <name>Create image migration README for documentation</name>
  <files>public/images/README.md</files>
  <action>
    Create README at `public/images/README.md` documenting the image migration:

    **Sections:**
    1. Directory structure explanation
    2. Category conventions (hero/, projects/, team/, services/, shared/)
    3. Responsive variant naming (640w, 1280w, 1920w)
    4. Format usage (WebP primary, JPG fallback)
    5. How to use image-mapping.json for lookup
    6. Nuxt Image component examples
    7. Srcset usage examples

    Include practical examples developers can copy into components.
  </action>
  <verify>`public/images/README.md` exists and contains helpful documentation</verify>
  <done>README provides clear guidance for using migrated images in components</done>
</task>

</tasks>

<verification>
After completion, verify:
1. `public/images/image-mapping.json` exists with valid JSON
2. `.planning/audit/image-mapping.json` exists with valid JSON
3. Both files contain identical image data
4. Each entry has: sourceUrl, category, variant paths, srcset strings
5. All paths in mapping reference existing files in public/images/
6. Usage guide section is present with examples
7. Summary statistics are accurate
8. `public/images/README.md` exists with helpful documentation
9. Duplicate images properly reference shared location

Run: `cat public/images/image-mapping.json | jq '.summary'` to view mapping summary
</verification>

<success_criteria>
1. Mapping generation script exists and executes successfully
2. Both mapping files generated with complete image catalog
3. All variant paths are valid and reference existing files
4. Srcset strings are properly formatted for direct use
5. Usage guide provides clear Nuxt Image examples
6. README.md documents the image organization system
7. Summary statistics match optimized-images.json counts
8. Phase 3 success criteria from ROADMAP.md are met:
   - All images downloaded and organized in public/images/
   - Images converted to WebP with JPG fallback
   - Responsive variants (640w, 1280w, 1920w) generated
   - Image mapping file documents source URL to local path
</success_criteria>

<output>
After completion, create `.planning/phases/03-image-migration/03-03-SUMMARY.md` with:
- Total images in mapping
- Duplicate count and space saved
- Breakdown by category
- Phase 3 completion confirmation (all success criteria met)
- Next steps recommendation (begin updating components to use migrated images)
</output>
