---
phase: 04-content-seo-validation
plan: 04
type: execute
wave: 4
depends_on: ["04-01", "04-03"]
files_modified:
  - .planning/audit/url-inventory.csv
  - .planning/audit/redirect-rules.json
  - nuxt.config.ts
autonomous: true

must_haves:
  truths:
    - "All source URLs documented in inventory"
    - "URL mappings recorded for changed URLs"
    - "301 redirects configured in Nuxt routeRules"
    - "Legacy WordPress URLs redirect to correct Nuxt pages"
    - "No 404 errors for previously valid URLs"
  artifacts:
    - path: ".planning/audit/url-inventory.csv"
      provides: "Complete inventory of source URLs with status and mapping"
      contains: "source_url,target_url,status,redirect_type"
    - path: ".planning/audit/redirect-rules.json"
      provides: "Redirect rules for Nuxt routeRules configuration"
      contains: "[{\"from\",\"to\",\"statusCode\""
    - path: "nuxt.config.ts"
      provides: "Updated Nuxt config with 301 redirect routeRules"
      contains: "routeRules"
  key_links:
    - from: "nuxt.config.ts"
      to: "04-05-PLAN.md"
      via: "Redirect rules needed before final sitemap generation"
      pattern: "routeRules"
    - from: ".planning/audit/url-inventory.csv"
      to: ".planning/audit/pages.json"
      via: "Source URLs from pages.json documented with mappings"
      pattern: "pages.json"
---

<objective>
Document URL structure changes between the WordPress source site and Nuxt target, create a URL inventory, and implement 301 redirects for all changed URLs to preserve SEO value.

Purpose: Preserve search engine rankings by ensuring all previously valid URLs either remain the same or redirect permanently (301) to the new location. Changed URLs without redirects cause 404 errors and loss of SEO traffic.

Output: URL inventory at `.planning/audit/url-inventory.csv`, redirect rules in Nuxt routeRules
</objective>

<execution_context>
@/home/deck/.claude/get-shit-done/workflows/execute-plan.md
@/home/deck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-content-seo-validation/04-RESEARCH.md
@.planning/audit/pages.json
@.planning/phases/04-content-seo-validation/04-01-SUMMARY.md
@.planning/phases/04-content-seo-validation/04-03-SUMMARY.md
@/home/deck/Sites/vp-eng-nuxt/nuxt.config.ts
</context>

<tasks>

<task type="auto">
  <name>Create URL inventory generation script</name>
  <files>.planning/scripts/generate-url-inventory.ts</files>
  <action>
    Create TypeScript script at `.planning/scripts/generate-url-inventory.ts` with the following structure:

    **Imports:**
    ```typescript
    import { readFileSync, writeFileSync } from 'fs'
    import { join } from 'path'
    ```

    **Interfaces:**
    ```typescript
    interface PageEntry {
      url: string
      slug: string
      type: string
      title?: string
    }

    interface UrlMapping {
      sourceUrl: string
      targetUrl: string
      status: 'unchanged' | 'changed' | 'removed'
      redirectType: 'none' | '301' | '410'
      notes: string
    }

    interface UrlInventory {
      generated: string
      totalUrls: number
      unchanged: number
      changed: number
      removed: number
      mappings: UrlMapping[]
    }

    interface RedirectRule {
      from: string
      to: string
      statusCode: 301
    }
    ```

    **URL Mapping Configuration:**

    Define known URL changes:
    ```typescript
    const URL_MAPPINGS: Record<string, string> = {
      // WordPress → Nuxt URL mappings
      '/about-3/': '/about',
      '/portfolio/': '/projects',
      '/gallery/132/': '/projects/132',
      '/gallery/bridges/': '/projects/bridges',
      '/gallery/commercial/': '/projects/commercial',
      '/gallery/misc/': '/projects/misc',

      // Additional mappings discovered during audit
      // Add as needed
    }

    const REMOVED_URLS: string[] = [
      // URLs that should return 410 Gone
      '/hello-world/',  // Default WordPress post
      '/category/uncategorized/',
      '/author/root/',
    ]
    ```

    **Functions to implement:**

    1. `function normalizeUrl(url: string): string`
       - Remove domain, keep path
       - Ensure trailing slash consistency
       - Return normalized path

    2. `function determineTarget(sourceUrl: string): UrlMapping`
       - Check if URL is in REMOVED_URLS
       - Check if URL has mapping in URL_MAPPINGS
       - Otherwise, URL is unchanged
       - Return UrlMapping with appropriate status

    3. `function generateInventory(pages: PageEntry[]): UrlInventory`
       - For each page, determine target URL
       - Categorize as unchanged, changed, or removed
       - Build mappings array
       - Calculate summary statistics
       - Return complete inventory

    4. `function generateRedirectRules(inventory: UrlInventory): RedirectRule[]`
       - Filter inventory for changed URLs
       - Create RedirectRule objects for each
       - Return array of redirect rules

    5. `function writeCsv(inventory: UrlInventory, path: string): void`
       - Write CSV with headers: source_url,target_url,status,redirect_type,notes
       - One row per URL mapping
       - Handle commas in notes with proper CSV quoting

    **Main execution:**
    ```typescript
    async function main() {
      // Load pages from audit
      const pagesPath = join(process.cwd(), '.planning', 'audit', 'pages.json')
      const pages: PageEntry[] = JSON.parse(readFileSync(pagesPath, 'utf-8'))

      console.log(`Generating URL inventory for ${pages.length} pages...`)

      // Generate inventory
      const inventory = generateInventory(pages)

      // Write JSON inventory
      const jsonPath = join(process.cwd(), '.planning', 'audit', 'url-inventory.json')
      writeFileSync(jsonPath, JSON.stringify(inventory, null, 2))

      // Write CSV inventory
      const csvPath = join(process.cwd(), '.planning', 'audit', 'url-inventory.csv')
      writeCsv(inventory, csvPath)

      // Generate and write redirect rules
      const redirectRules = generateRedirectRules(inventory)
      const rulesPath = join(process.cwd(), '.planning', 'audit', 'redirect-rules.json')
      writeFileSync(rulesPath, JSON.stringify(redirectRules, null, 2))

      // Log summary
      console.log('\n=== URL Inventory Summary ===')
      console.log(`Total URLs: ${inventory.totalUrls}`)
      console.log(`  Unchanged: ${inventory.unchanged}`)
      console.log(`  Changed: ${inventory.changed}`)
      console.log(`  Removed: ${inventory.removed}`)

      console.log(`\n✓ URL inventory generated:`)
      console.log(`  JSON: ${jsonPath}`)
      console.log(`  CSV: ${csvPath}`)
      console.log(`  Redirect rules: ${rulesPath}`)

      if (inventory.changed > 0) {
        console.log(`\n⚠️ ${inventory.changed} URLs require 301 redirects!`)
      }
    }

    main().catch(console.error)
    ```

    **Important:**
    - Include all known URL mappings from WordPress to Nuxt
    - Mark removed URLs for 410 Gone status
    - Generate both JSON and CSV for human review
    - CSV format should be Excel-compatible
  </action>
  <verify>Script file exists at `.planning/scripts/generate-url-inventory.ts` with all required functions</verify>
  <done>URL inventory generation script created with complete implementation</done>
</task>

<task type="auto">
  <name>Execute URL inventory generation</name>
  <files>.planning/audit/url-inventory.csv, .planning/audit/url-inventory.json, .planning/audit/redirect-rules.json</files>
  <action>
    Run the URL inventory generation script:

    ```bash
    npx tsx .planning/scripts/generate-url-inventory.ts
    ```

    The script will:
    1. Load pages from `.planning/audit/pages.json`
    2. Apply URL mappings
    3. Identify changed, unchanged, and removed URLs
    4. Generate JSON inventory
    5. Generate CSV inventory
    6. Generate redirect rules for Nuxt

    After completion, review the outputs:
    ```bash
    # View CSV inventory
    cat .planning/audit/url-inventory.csv

    # View redirect rules
    cat .planning/audit/redirect-rules.json
    ```
  </action>
  <verify>`.planning/audit/url-inventory.csv` and `.planning/audit/redirect-rules.json` exist with valid data</verify>
  <done>URL inventory and redirect rules generated</done>
</task>

<task type="auto">
  <name>Configure Nuxt routeRules with 301 redirects</name>
  <files>nuxt.config.ts</files>
  <action>
    Update `nuxt.config.ts` to add 301 redirects for changed URLs.

    Read the current `nuxt.config.ts` and locate the `routeRules` section (currently in `nitro.routeRules`).

    **Current routeRules location:**
    The file has `nitro.routeRules` for cache headers. Redirects can be added there or as a top-level `routeRules` key.

    **Add redirect rules:**

    Add redirect rules to the routeRules configuration. The redirects should be added at the top level (not nested in nitro):

    ```typescript
    export default defineNuxtConfig({
      // ... existing config ...

      routeRules: {
        // 301 redirects for URL changes from WordPress migration
        '/about-3': { redirect: { to: '/about', statusCode: 301 } },
        '/about-3/': { redirect: { to: '/about', statusCode: 301 } },
        '/portfolio': { redirect: { to: '/projects', statusCode: 301 } },
        '/portfolio/': { redirect: { to: '/projects', statusCode: 301 } },
        '/gallery/132': { redirect: { to: '/projects/132', statusCode: 301 } },
        '/gallery/132/': { redirect: { to: '/projects/132', statusCode: 301 } },
        '/gallery/bridges': { redirect: { to: '/projects/bridges', statusCode: 301 } },
        '/gallery/bridges/': { redirect: { to: '/projects/bridges', statusCode: 301 } },
        '/gallery/commercial': { redirect: { to: '/projects/commercial', statusCode: 301 } },
        '/gallery/commercial/': { redirect: { to: '/projects/commercial', statusCode: 301 } },
        '/gallery/misc': { redirect: { to: '/projects/misc', statusCode: 301 } },
        '/gallery/misc/': { redirect: { to: '/projects/misc', statusCode: 301 } },
      },

      nitro: {
        // ... existing nitro config including routeRules for caching ...
        // Keep existing cache header rules
      },
    })
    ```

    **Important notes:**
    - Redirects work at both `/path` and `/path/` variations
    - Use statusCode: 301 for permanent redirects (SEO-preserving)
    - Keep existing nitro.routeRules for cache headers
    - Test redirects after configuration

    **Verification after update:**
    The routeRules section should now include both redirects (top-level) and cache headers (nested in nitro).
  </action>
  <verify>`nuxt.config.ts` updated with routeRules containing 301 redirects for all changed URLs</verify>
  <done>Nuxt routeRules configured with 301 redirects</done>
</task>

<task type="auto">
  <name>Verify redirect configuration</name>
  <files>nuxt.config.ts</files>
  <action>
    Verify the redirect configuration is correct by:

    1. **Check config syntax:**
       ```bash
       # Verify config is valid TypeScript
       npx nuxi typecheck
       ```

    2. **Review redirect rules:**
       ```bash
       # Count redirect rules in config
       grep -c "statusCode: 301" nuxt.config.ts
       ```

    3. **Document redirects in task commit:**
       - List all redirect mappings configured
       - Note any trailing slash handling
       - Confirm all changed URLs from inventory are covered

    Expected results:
    - No TypeScript errors
    - All changed URLs have redirect rules
    - Both `/path` and `/path/` variations handled

    The dev server from previous tasks should still be running. If stopped, restart it to test redirects:
    ```bash
    # If server stopped, restart
    npm run dev
    ```

    Test a redirect in browser or with curl (if server running):
    ```bash
    # Should return 301 with Location header
    curl -I http://localhost:3000/about-3
    ```
  </action>
  <verify>Config syntax is valid, all redirect rules present</verify>
  <done>Redirect configuration verified and documented</done>
</task>

<task type="auto">
  <name>Document URL structure and redirects</name>
  <files>.planning/phases/04-content-seo-validation/04-04-SUMMARY.md</files>
  <action>
    Create documentation of URL structure changes and redirect implementation:

    Document:
    1. **Total URLs in inventory** - unchanged, changed, removed
    2. **Redirect mappings configured** - list each source → target
    3. **Removed URLs** - URLs returning 410 Gone
    4. **Testing notes** - how to verify redirects work

    Include in documentation:
    - URL inventory location for reference
    - How to add new redirects if needed
    - Google Search Console verification steps (after deployment)

    **Google Search Console steps (for after deployment):**
    1. Add new site property to GSC
    2. Submit sitemap.xml
    3. Use URL Inspection tool to verify redirects
    4. Check Coverage report for 404 errors
    5. Monitor for redirect chain issues
  </action>
  <verify>URL structure and redirects documented completely</verify>
  <done>URL structure documentation complete with testing notes</done>
</task>

</tasks>

<verification>
After completion, verify:
1. `.planning/scripts/generate-url-inventory.ts` exists with complete implementation
2. `.planning/audit/url-inventory.csv` exists with all URLs documented
3. `.planning/audit/url-inventory.json` exists with structured data
4. `.planning/audit/redirect-rules.json` contains all redirect mappings
5. `nuxt.config.ts` routeRules includes 301 redirects
6. Config syntax is valid (no TypeScript errors)
7. REQ-SEO-002 acceptance criteria met:
   - Source URLs documented in url-inventory.csv
   - Changed URLs mapped to source
   - 301 redirects implemented via routeRules
   - Redirect configuration verified
8. Documentation includes Google Search Console verification steps
</verification>

<success_criteria>
1. URL inventory generation script created and executes successfully
2. Complete URL inventory generated (CSV and JSON formats)
3. All changed URLs have 301 redirects configured
4. Removed URLs documented for 410 status
5. Nuxt config updated with valid redirect rules
6. REQ-SEO-002 acceptance criteria met
7. Documentation complete with testing instructions
</success_criteria>

<output>
After completion, create `.planning/phases/04-content-seo-validation/04-04-SUMMARY.md` with:
- Total URLs documented (unchanged, changed, removed)
- List of redirect mappings implemented
- Confirmation of REQ-SEO-002 completion
- Testing notes for redirect verification
- Google Search Console verification steps
- Next steps recommendation (proceed to 04-05 sitemap generation)
</output>
