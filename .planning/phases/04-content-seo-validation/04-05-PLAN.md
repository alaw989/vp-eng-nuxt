---
phase: 04-content-seo-validation
plan: 05
type: execute
wave: 5
depends_on: ["04-01", "04-02", "04-03", "04-04"]
files_modified:
  - server/routes/sitemap.xml.ts
  - .planning/audit/sitemap-verification.json
autonomous: true

must_haves:
  truths:
    - "XML sitemap accessible at /sitemap.xml"
    - "All static pages included in sitemap"
    - "All dynamic routes (projects, services) included"
    - "Proper lastmod timestamps configured"
    - "Sitemap ready for Google Search Console submission"
  artifacts:
    - path: "server/routes/sitemap.xml.ts"
      provides: "Dynamic sitemap generation with all routes"
      contains: "defineEventHandler"
    - path: ".planning/audit/sitemap-verification.json"
      provides: "Sitemap verification results with URL counts"
      contains: "[{\"url\",\"lastmod\",\"changefreq\""
  key_links:
    - from: "server/routes/sitemap.xml.ts"
      to: "nuxt.config.ts"
      via: "Works with @nuxtjs/sitemap module configuration"
      pattern: "sitemap"
    - from: ".planning/audit/sitemap-verification.json"
      to: "Google Search Console"
      via: "Sitemap submission after deployment"
      pattern: "sitemap-verification.json"
---

<objective>
Verify and enhance the XML sitemap generation to ensure all pages (static and dynamic) are included with proper metadata. Generate a sitemap verification report confirming the sitemap is ready for Google Search Console submission.

Purpose: XML sitemaps help search engines discover and index all pages. A complete sitemap with proper lastmod timestamps ensures search engines crawl the site efficiently and understand content freshness.

Output: Verified sitemap at `/sitemap.xml`, verification report at `.planning/audit/sitemap-verification.json`
</objective>

<execution_context>
@/home/deck/.claude/get-shit-done/workflows/execute-plan.md
@/home/deck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-content-seo-validation/04-RESEARCH.md
@.planning/audit/pages.json
@.planning/phases/04-content-seo-validation/04-01-SUMMARY.md
@.planning/phases/04-content-seo-validation/04-02-SUMMARY.md
@.planning/phases/04-content-seo-validation/04-03-SUMMARY.md
@.planning/phases/04-content-seo-validation/04-04-SUMMARY.md
@/home/deck/Sites/vp-eng-nuxt/server/routes/sitemap.xml.ts
@/home/deck/Sites/vp-eng-nuxt/nuxt.config.ts
</context>

<tasks>

<task type="auto">
  <name>Review existing sitemap configuration</name>
  <files>nuxt.config.ts, server/routes/sitemap.xml.ts</files>
  <action>
    Review the current sitemap setup:

    1. **Check nuxt.config.ts sitemap module configuration:**
       - Verify @nuxtjs/sitemap is in modules array
       - Review sitemap configuration (exclude, defaults, urls)
       - Note any static URLs configured

    2. **Check server/routes/sitemap.xml.ts:**
       - Review dynamic route generation logic
       - Check which post types are fetched (projects, services)
       - Verify lastmod handling
       - Note any missing routes

    Current implementation fetches:
    - Static pages (hardcoded)
    - Services from WordPress API
    - Projects from WordPress API

    **Identify gaps:**
    - Are careers detail pages included?
    - Are all project slugs from source covered?
    - Are all service slugs from source covered?
    - Is the about page properly included?
  </action>
  <verify>Existing sitemap configuration reviewed and gaps identified</verify>
  <done>Sitemap configuration reviewed with enhancement notes documented</done>
</task>

<task type="auto">
  <name>Enhance sitemap with missing routes</name>
  <files>server/routes/sitemap.xml.ts</files>
  <action>
    Update `server/routes/sitemap.xml.ts` to ensure all routes are included:

    **Enhancements to add:**

    1. **Add careers detail pages** (if careers endpoint exists):
       ```typescript
       // Fetch careers from WordPress API
       const careersResponse = await fetch(`${wpApiUrl}/careers?per_page=100&_fields=slug,date`)
       if (careersResponse.ok) {
         const careers = await careersResponse.json()
         for (const career of careers) {
           urls.push({
             loc: `/careers/${career.slug}`,
             lastmod: career.date ? new Date(career.date).toISOString() : undefined,
             changefreq: 'monthly',
             priority: 0.6,
           })
         }
       }
       ```

    2. **Ensure all static pages are included:**
       Verify the static pages list includes:
       - / (home)
       - /about
       - /services
       - /projects
       - /contact
       - /careers
       - /search

    3. **Add error handling for missing endpoints:**
       Wrap each API fetch in try/catch to handle missing endpoints gracefully:
       ```typescript
       try {
         const response = await fetch(...)
         if (response.ok) {
           // process response
         }
       } catch (error) {
         console.warn('Failed to fetch [endpoint]:', error)
       }
       ```

    4. **Add XML declaration and proper formatting:**
       Ensure the XML output is properly formatted with:
       - XML declaration: `<?xml version="1.0" encoding="UTF-8"?>`
       - urlset namespace: `xmlns="http://www.sitemaps.org/schemas/sitemap/0.9"`
       - Proper indentation for readability

    **Updated structure:**
    ```typescript
    export default defineEventHandler(async (event) => {
      const siteUrl = process.env.NUXT_PUBLIC_SITE_URL || 'https://vp-associates.com'
      const wpApiUrl = process.env.NUXT_PUBLIC_WP_API_URL || 'https://www.vp-associates.com/wp-json/wp/v2'

      const urls: Array<{
        loc: string
        lastmod?: string
        changefreq?: string
        priority?: number
      }> = [
        // Static pages
        { loc: '/', changefreq: 'daily', priority: 1.0 },
        { loc: '/about', changefreq: 'monthly', priority: 0.9 },
        { loc: '/services', changefreq: 'weekly', priority: 0.9 },
        { loc: '/projects', changefreq: 'weekly', priority: 0.9 },
        { loc: '/contact', changefreq: 'monthly', priority: 0.8 },
        { loc: '/careers', changefreq: 'monthly', priority: 0.7 },
        { loc: '/search', changefreq: 'weekly', priority: 0.6 },
      ]

      // Fetch dynamic routes
      // Services, Projects, Careers with error handling

      // Generate XML
      const xml = `<?xml version="1.0" encoding="UTF-8"?>
    <urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
    ${urls.map(url => `  <url>
      <loc>${siteUrl}${url.loc}</loc>
    ${url.lastmod ? `    <lastmod>${url.lastmod}</lastmod>\n` : ''}    <changefreq>${url.changefreq}</changefreq>
      <priority>${url.priority}</priority>
    </url>`).join('\n')}
    </urlset>`

      setHeader(event, 'content-type', 'application/xml')
      return xml
    })
    ```

    **Important:**
    - Add careers endpoint if it exists in WordPress API
    - Handle missing endpoints gracefully
    - Use proper priority values (1.0 for home, 0.9-0.7 for main pages, 0.6 for detail pages)
    - Set appropriate changefreq (daily for home, weekly for listings, monthly for details)
  </action>
  <verify>`server/routes/sitemap.xml.ts` updated with all routes and error handling</verify>
  <done>Sitemap enhanced with missing routes and error handling</done>
</task>

<task type="auto">
  <name>Create sitemap verification script</name>
  <files>.planning/scripts/verify-sitemap.ts</files>
  <action>
    Create TypeScript script at `.planning/scripts/verify-sitemap.ts` to verify the sitemap:

    **Imports:**
    ```typescript
    import { ofetch } from 'ofetch'
    import * as cheerio from 'cheerio'
    import { readFileSync, writeFileSync } from 'fs'
    import { join } from 'path'
    ```

    **Interfaces:**
    ```typescript
    interface SitemapUrl {
      loc: string
      lastmod?: string
      changefreq?: string
      priority?: number
    }

    interface SitemapVerification {
      generated: string
      sitemapUrl: string
      status: number
      urlCount: number
      staticUrls: string[]
      dynamicUrls: {
        projects: string[]
        services: string[]
        careers: string[]
      }
      expectedUrls: string[]
      missingUrls: string[]
      lastmodPresent: number
      summary: {
        totalExpected: number
        totalFound: number
        coverage: number
      }
    }
    ```

    **Functions to implement:**

    1. `async function fetchSitemap(baseUrl: string): Promise<string>`
       - Fetch sitemap.xml from the server
       - Return XML string

    2. `function parseSitemap(xml: string): SitemapUrl[]`
       - Use Cheerio with xmlMode: true
       - Parse all <url> elements
       - Extract loc, lastmod, changefreq, priority
       - Return array of SitemapUrl

    3. `function categorizeUrls(urls: SitemapUrl[]): SitemapVerification['dynamicUrls']`
       - Categorize by path pattern
       - /projects/* → projects array
       - /services/* → services array
       - /careers/* → careers array
       - /, /about, etc. → static array

    4. `function verifyCoverage(urls: SitemapUrl[], expectedPages: any[]): SitemapVerification`
       - Compare sitemap URLs against expected pages from pages.json
       - Identify missing URLs
       - Calculate coverage percentage
       - Count URLs with lastmod
       - Return verification report

    **Main execution:**
    ```typescript
    async function main() {
      const BASE_URL = process.env.NUXT_PUBLIC_SITE_URL || 'http://localhost:3000'
      const SITEMAP_URL = `${BASE_URL}/sitemap.xml`

      console.log(`Verifying sitemap at: ${SITEMAP_URL}`)

      // Fetch and parse sitemap
      const xml = await fetchSitemap(SITEMAP_URL)
      const urls = parseSitemap(xml)

      // Load expected pages
      const pagesPath = join(process.cwd(), '.planning', 'audit', 'pages.json')
      const expectedPages = JSON.parse(readFileSync(pagesPath, 'utf-8'))

      // Verify coverage
      const verification = verifyCoverage(urls, expectedPages)

      // Write report
      const reportPath = join(process.cwd(), '.planning', 'audit', 'sitemap-verification.json')
      writeFileSync(reportPath, JSON.stringify(verification, null, 2))

      // Log summary
      console.log('\n=== Sitemap Verification ===')
      console.log(`Status: ${verification.status}`)
      console.log(`URLs in sitemap: ${verification.urlCount}`)
      console.log(`Static pages: ${verification.staticUrls.length}`)
      console.log(`Dynamic projects: ${verification.dynamicUrls.projects.length}`)
      console.log(`Dynamic services: ${verification.dynamicUrls.services.length}`)
      console.log(`Dynamic careers: ${verification.dynamicUrls.careers.length}`)
      console.log(`\nCoverage:`)
      console.log(`  Expected: ${verification.summary.totalExpected}`)
      console.log(`  Found: ${verification.summary.totalFound}`)
      console.log(`  Coverage: ${verification.summary.coverage.toFixed(1)}%`)

      if (verification.missingUrls.length > 0) {
        console.log(`\n⚠️ Missing URLs:`)
        verification.missingUrls.forEach(url => console.log(`  - ${url}`))
      }
    }

    main().catch(console.error)
    ```
  </action>
  <verify>Script file exists at `.planning/scripts/verify-sitemap.ts` with all required functions</verify>
  <done>Sitemap verification script created with complete implementation</done>
</task>

<task type="checkpoint:human-verify">
  <name>Verify Nuxt dev server is running for sitemap test</name>
  <files>None</files>
  <action>
    The Nuxt dev server should be running to test the sitemap endpoint.

    **How to verify:**
    1. Check if http://localhost:3000/sitemap.xml loads
    2. In browser: http://localhost:3000/sitemap.xml
    3. Or with curl: `curl -s http://localhost:3000/sitemap.xml | head -20`

    Expected: XML sitemap with urlset elements

    If server not running, start it: `npm run dev`
  </action>
  <done>Sitemap endpoint confirmed accessible and returning XML</done>
</task>

<task type="auto">
  <name>Execute sitemap verification</name>
  <files>.planning/audit/sitemap-verification.json</files>
  <action>
    Run the sitemap verification script:

    ```bash
    npx tsx .planning/scripts/verify-sitemap.ts
    ```

    The script will:
    1. Fetch sitemap from localhost:3000/sitemap.xml
    2. Parse all URLs from the sitemap
    3. Categorize URLs (static, projects, services, careers)
    4. Compare against expected pages from pages.json
    5. Generate verification report

    After completion, review the report:
    ```bash
    # View verification summary
    cat .planning/audit/sitemap-verification.json | jq '.summary'

    # View missing URLs (if any)
    cat .planning/audit/sitemap-verification.json | jq '.missingUrls'
    ```
  </action>
  <verify>`.planning/audit/sitemap-verification.json` exists with complete verification data</verify>
  <done>Sitemap verification complete with coverage report generated</done>
</task>

<task type="auto">
  <name>Document sitemap verification and Search Console steps</name>
  <files>.planning/phases/04-content-seo-validation/04-05-SUMMARY.md</files>
  <action>
    Create comprehensive documentation including:

    1. **Sitemap verification results:**
       - Total URLs in sitemap
       - Coverage percentage vs expected pages
       - Any missing URLs identified
       - lastmod timestamp presence

    2. **Sitemap access confirmation:**
       - Sitemap URL: https://vp-associates.com/sitemap.xml
       - Content-Type: application/xml
       - Proper XML formatting confirmed

    3. **Google Search Console submission steps:**
       - Add site property to GSC
       - Navigate to: Indexing → Sitemaps
       - Submit sitemap URL: https://vp-associates.com/sitemap.xml
       - Monitor "Submitted" vs "Indexed" count
       - Check for coverage issues

    4. **Post-deployment verification:**
       - After deployment, test sitemap at production URL
       - Use URL Inspection tool for sample pages
       - Check Index Status report
       - Monitor for crawl errors

    5. **Phase 4 completion summary:**
       - All REQ-LNK-001, REQ-LNK-002 requirements met
       - All REQ-SEO-001, REQ-SEO-002, REQ-SEO-003 requirements met
       - Ready for Phase 5: QA & PWA Foundation
  </action>
  <verify>Sitemap documentation complete with Search Console steps and phase summary</verify>
  <done>Sitemap verification and Search Console documentation complete</done>
</task>

</tasks>

<verification>
After completion, verify:
1. `server/routes/sitemap.xml.ts` includes all routes (static + dynamic)
2. Error handling added for missing WordPress endpoints
3. `.planning/scripts/verify-sitemap.ts` exists with complete implementation
4. `.planning/audit/sitemap-verification.json` exists with verification data
5. Sitemap accessible at /sitemap.xml returning valid XML
6. Coverage percentage calculated and documented
7. REQ-SEO-003 acceptance criteria met:
   - @nuxtjs/sitemap module configured
   - All dynamic routes included (projects, services, careers)
   - Proper lastmod timestamps present
   - Sitemap accessible at /sitemap.xml
   - Search Console submission steps documented
</verification>

<success_criteria>
1. Sitemap enhanced with all missing routes
2. Sitemap verification script created and executes successfully
3. Verification report generated with coverage data
4. Sitemap accessible and returning valid XML
5. Google Search Console submission steps documented
6. REQ-SEO-003 acceptance criteria met
7. Phase 4 complete (all 5 plans finished)
8. Ready for Phase 5: QA & PWA Foundation
</success_criteria>

<output>
After completion, create `.planning/phases/04-content-seo-validation/04-05-SUMMARY.md` with:
- Total URLs in sitemap
- Coverage percentage vs expected
- Confirmation of REQ-SEO-003 completion
- Google Search Console submission steps
- Phase 4 completion summary:
  - REQ-LNK-001: Link validation complete
  - REQ-LNK-002: Content integrity verified
  - REQ-SEO-001: Meta tags compared
  - REQ-SEO-002: URL structure and redirects configured
  - REQ-SEO-003: Sitemap verified
- Next steps recommendation (proceed to Phase 5: QA & PWA Foundation)
</output>
