---
phase: 04-content-seo-validation
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - .planning/audit/content-comparison.json
  - .planning/scripts/compare-content.ts
autonomous: true

must_haves:
  truths:
    - "Text content extracted from both source and target pages"
    - "Headings, paragraphs, and lists compared for presence"
    - "Similarity percentage calculated for each page"
    - "Content changes >10% flagged for review"
    - "Report shows side-by-side content comparison"
  artifacts:
    - path: ".planning/audit/content-comparison.json"
      provides: "Side-by-side content comparison with similarity scores"
      contains: "[{\"page\",\"sourceContent\",\"targetContent\",\"similarity\""
    - path: ".planning/scripts/compare-content.ts"
      provides: "Reusable content comparison script for future audits"
      contains: "export async function compareContent"
  key_links:
    - from: ".planning/audit/content-comparison.json"
      to: ".planning/audit/pages.json"
      via: "Uses page URLs to fetch both source and target content"
      pattern: "pages.json"
    - from: ".planning/scripts/compare-content.ts"
      to: "04-03-PLAN.md"
      via: "Content comparison foundation needed before meta tag verification"
      pattern: "compare-content.ts"
---

<objective>
Create and execute a content integrity comparison script that extracts text content from source WordPress pages and corresponding Nuxt pages, compares them for similarity, and flags pages with significant content differences (>10%).

Purpose: Verify that content migration preserved all important text content. Significant content loss or changes during migration can hurt SEO and user experience. The comparison report identifies pages needing review.

Output: Content comparison report at `.planning/audit/content-comparison.json` with similarity scores and flagged differences
</objective>

<execution_context>
@/home/deck/.claude/get-shit-done/workflows/execute-plan.md
@/home/deck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-content-seo-validation/04-RESEARCH.md
@.planning/audit/pages.json
@.planning/phases/04-content-seo-validation/04-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Create content comparison script</name>
  <files>.planning/scripts/compare-content.ts</files>
  <action>
    Create TypeScript script at `.planning/scripts/compare-content.ts` with the following structure:

    **Imports:**
    ```typescript
    import { ofetch } from 'ofetch'
    import * as cheerio from 'cheerio'
    import { readFileSync, writeFileSync } from 'fs'
    import { join } from 'path'
    ```

    **Interfaces:**
    ```typescript
    interface PageEntry {
      url: string
      slug: string
      type: string
      title?: string
    }

    interface TextContent {
      headings: string[]
      paragraphs: string[]
      lists: string[]
      rawText: string
    }

    interface ContentComparison {
      page: string
      slug: string
      sourceUrl: string
      targetUrl: string
      sourceContent: TextContent
      targetContent: TextContent
      comparison: {
        headingMatch: number      // percentage 0-100
        paragraphCountDiff: number
        listCountDiff: number
        overallSimilarity: number  // percentage 0-100
        flagged: boolean           // true if similarity < 90%
      }
      differences: {
        missingHeadings: string[]
        extraHeadings: string[]
        missingParagraphs: number
        contentHashDiff: string    // summary of text difference
      }
    }

    interface ContentComparisonReport {
      generated: string
      source: string
      target: string
      threshold: number
      pagesCompared: number
      summary: {
        passed: number      // similarity >= threshold
        flagged: number     // similarity < threshold
        avgSimilarity: number
      }
      comparisons: ContentComparison[]
    }
    ```

    **Functions to implement:**

    1. `function extractTextContent(html: string): TextContent`
       - Load HTML with Cheerio
       - Remove script, style, nav, footer, header elements (not content)
       - Extract h1-h6 headings into array
       - Extract p elements into array
       - Extract li elements into array
       - Generate rawText by concatenating all text content
       - Return TextContent object

    2. `function calculateSimilarity(text1: string, text2: string): number`
       - Implement Levenshtein distance algorithm
       - Calculate edit distance between strings
       - Return similarity percentage: ((maxLen - distance) / maxLen) * 100
       - Handle edge cases (empty strings)

    3. `function compareTextContent(source: TextContent, target: TextContent, threshold: number = 90): ContentComparison['comparison']`
       - Compare heading arrays for overlap
       - Count paragraph differences
       - Count list differences
       - Calculate overall similarity from rawText
       - Set flagged = true if similarity < threshold

    4. `function identifyDifferences(source: TextContent, target: TextContent): ContentComparison['differences']`
       - Find headings in source but not target
       - Find headings in target but not source
       - Count paragraph/list differences
       - Generate summary hash of text differences

    5. `async function fetchPageContent(url: string): Promise<string>`
       - Use ofetch to fetch page HTML
       - Return raw HTML string
       - Handle errors gracefully (return empty string)

    6. `function mapSourceToTarget(sourceUrl: string, sourceSlug: string): string`
       - Map WordPress URLs to Nuxt URLs
       - Known mappings:
         - /about-3/ → /about
         - /portfolio/ → /projects
         - /gallery/132/ → /projects/132
         - /gallery/bridges/ → /projects/bridges
         - /gallery/commercial/ → /projects/commercial
         - /gallery/misc/ → /projects/misc
       - Default: Convert to expected Nuxt path structure

    7. `async function comparePages(pages: PageEntry[], sourceUrl: string, targetUrl: string, threshold: number): Promise<ContentComparisonReport>`
       - For each page:
         - Fetch source HTML
         - Fetch target HTML (mapped URL)
         - Extract text from both
         - Compare and flag differences
         - Build comparison object
       - Calculate summary statistics
       - Return complete report

    **Levenshtein distance implementation:**
    ```typescript
    function levenshteinDistance(str1: string, str2: string): number {
      const len1 = str1.length
      const len2 = str2.length
      const matrix: number[][] = []

      for (let i = 0; i <= len2; i++) {
        matrix[i] = [i]
      }
      for (let j = 0; j <= len1; j++) {
        matrix[0][j] = j
      }

      for (let i = 1; i <= len2; i++) {
        for (let j = 1; j <= len1; j++) {
          if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
            matrix[i][j] = matrix[i - 1][j - 1]
          } else {
            matrix[i][j] = Math.min(
              matrix[i - 1][j - 1] + 1,
              matrix[i][j - 1] + 1,
              matrix[i - 1][j] + 1
            )
          }
        }
      }

      return matrix[len2][len1]
    }
    ```

    **Main execution:**
    ```typescript
    async function main() {
      const SOURCE_URL = 'https://www.vp-associates.com'
      const TARGET_URL = 'http://localhost:3000'  // Or use NUXT_PUBLIC_SITE_URL
      const THRESHOLD = 90  // Flag if similarity < 90%

      // Load pages from audit
      const pagesPath = join(process.cwd(), '.planning', 'audit', 'pages.json')
      const pages: PageEntry[] = JSON.parse(readFileSync(pagesPath, 'utf-8'))

      console.log(`Comparing content for ${pages.length} pages...`)
      console.log(`Source: ${SOURCE_URL}`)
      console.log(`Target: ${TARGET_URL}`)
      console.log(`Threshold: ${THRESHOLD}%\n`)

      // Run comparison
      const report = await comparePages(pages, SOURCE_URL, TARGET_URL, THRESHOLD)

      // Write report
      const reportPath = join(process.cwd(), '.planning', 'audit', 'content-comparison.json')
      writeFileSync(reportPath, JSON.stringify(report, null, 2))

      // Log summary
      console.log('=== Content Comparison Summary ===')
      console.log(`Pages compared: ${report.pagesCompared}`)
      console.log(`Passed (>=${THRESHOLD}%): ${report.summary.passed}`)
      console.log(`Flagged (<${THRESHOLD}%): ${report.summary.flagged}`)
      console.log(`Average similarity: ${report.summary.avgSimilarity.toFixed(1)}%`)

      if (report.summary.flagged > 0) {
        console.log(`\n⚠️ ${report.summary.flagged} pages flagged for content differences!`)
        console.log('\nFlagged pages:')
        report.comparisons
          .filter(c => c.comparison.flagged)
          .forEach(c => {
            console.log(`  - ${c.page}: ${c.comparison.overallSimilarity.toFixed(1)}% similarity`)
          })
      }
    }

    main().catch(console.error)
    ```

    **Important:**
    - Skip navigation, footer, header content (not page-specific)
    - Use 90% similarity threshold (10% difference = flag)
    - Map source URLs to correct Nuxt URLs
    - Handle missing target pages gracefully
  </action>
  <verify>Script file exists at `.planning/scripts/compare-content.ts` with all required functions</verify>
  <done>Content comparison script created with complete implementation</done>
</task>

<task type="checkpoint:human-action">
  <name>Start Nuxt dev server for content comparison</name>
  <files>None</files>
  <action>
    Before running the content comparison script, the Nuxt dev server must be running so target pages can be fetched.

    I cannot start the dev server automatically because it requires an ongoing process.

    **What you need to do:**
    1. In a separate terminal, start the dev server:
       ```bash
       npm run dev
       ```
    2. Wait for server to start (shows "Local: http://localhost:3000")
    3. Leave the server running

    **I'll verify after:**
    Server responds at http://localhost:3000
  </action>
  <done>Dev server running and accessible</done>
</task>

<task type="auto">
  <name>Execute content comparison</name>
  <files>.planning/audit/content-comparison.json</files>
  <action>
    Run the content comparison script:

    ```bash
    npx tsx .planning/scripts/compare-content.ts
    ```

    The script will:
    1. Load pages from `.planning/audit/pages.json`
    2. Fetch each page from source (vp-associates.com)
    3. Fetch corresponding page from target (localhost:3000)
    4. Extract text content from both
    5. Calculate similarity scores
    6. Flag pages with <90% similarity

    Expected runtime: 1-2 minutes.

    After completion, review the report:
    ```bash
    # View flagged pages
    cat .planning/audit/content-comparison.json | jq '.comparisons[] | select(.comparison.flagged) | {page, similarity: .comparison.overallSimilarity}'

    # View summary
    cat .planning/audit/content-comparison.json | jq '.summary'
    ```
  </action>
  <verify>`.planning/audit/content-comparison.json` exists and contains valid JSON with comparison data</verify>
  <done>Content comparison complete with flagged pages identified</done>
</task>

<task type="auto">
  <name>Document content comparison findings</name>
  <files>.planning/phases/04-content-seo-validation/04-02-SUMMARY.md</files>
  <action>
    Analyze the content comparison report and document findings:

    1. **Count of pages compared** vs total pages
    2. **Pages flagged** with low similarity
    3. **Average similarity** across all pages
    4. **Common differences** observed (e.g., missing headings, nav content)
    5. **Action items** for pages requiring manual review

    Expected findings may include:
    - Lower similarity due to navigation/footer differences (acceptable)
    - Missing content on migrated pages (needs fixing)
    - Reordered content (acceptable if same text present)
    - WordPress-specific content removed (intentional)

    Document which differences are acceptable vs which require action.

    Note: Content structure changes (HTML structure vs semantic content) are expected. Focus on text content preservation.
  </action>
  <verify>Content comparison findings documented with actionable items</verify>
  <done>Content comparison analysis complete with findings recorded</done>
</task>

</tasks>

<verification>
After completion, verify:
1. `.planning/scripts/compare-content.ts` exists with complete implementation
2. `.planning/audit/content-comparison.json` exists and contains valid JSON
3. Report includes: generated timestamp, pagesCompared count, threshold
4. Summary has counts for: passed, flagged, avgSimilarity
5. Comparisons array includes: sourceContent, targetContent, similarity, flagged
6. Flagged pages identified and documented
7. REQ-LNK-002 acceptance criteria met:
   - Text content extracted from source and target
   - Headings, paragraphs, lists compared
   - Changes >10% flagged (threshold <90%)
   - Report generated with side-by-side comparison
</verification>

<success_criteria>
1. Content comparison script created and executes successfully
2. Content comparison report generated with similarity scores
3. Pages with significant content differences flagged
4. Findings documented with actionable recommendations
5. REQ-LNK-002 acceptance criteria met
6. Dev server was running during execution (documented in SUMMARY)
</success_criteria>

<output>
After completion, create `.planning/phases/04-content-seo-validation/04-02-SUMMARY.md` with:
- Total pages compared
- Average similarity percentage
- Count of flagged pages
- Analysis of flagged pages (acceptable vs action needed)
- Confirmation of REQ-LNK-002 completion
- Next steps recommendation (proceed to 04-03 meta tag verification)
</output>
