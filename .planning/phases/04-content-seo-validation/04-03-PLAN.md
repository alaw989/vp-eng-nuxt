---
phase: 04-content-seo-validation
plan: 03
type: execute
wave: 3
depends_on: ["04-01", "04-02"]
files_modified:
  - .planning/audit/seo-comparison.json
  - .planning/scripts/extract-meta.ts
autonomous: true

must_haves:
  truths:
    - "Meta tags extracted from source WordPress pages"
    - "Meta tags extracted from target Nuxt pages"
    - "Open Graph tags compared (og:title, og:description, og:image)"
    - "Twitter Card tags compared"
    - "Missing or different meta tags documented"
  artifacts:
    - path: ".planning/audit/seo-comparison.json"
      provides: "Side-by-side meta tag comparison with discrepancies flagged"
      contains: "[{\"page\",\"sourceMeta\",\"targetMeta\",\"matches\""
    - path: ".planning/scripts/extract-meta.ts"
      provides: "Reusable meta tag extraction script for future audits"
      contains: "export async function extractAndCompareMeta"
  key_links:
    - from: ".planning/audit/seo-comparison.json"
      to: ".planning/audit/pages.json"
      via: "Uses page URLs to fetch both source and target meta tags"
      pattern: "pages.json"
    - from: ".planning/scripts/extract-meta.ts"
      to: "04-04-PLAN.md"
      via: "Meta tag verification needed before URL structure documentation"
      pattern: "extract-meta.ts"
---

<objective>
Create and execute a meta tag extraction and comparison script that extracts SEO meta tags (title, description, keywords, Open Graph, Twitter Cards) from source WordPress pages and corresponding Nuxt pages, then compares them to identify missing or differing tags.

Purpose: Verify that all SEO meta tags are preserved during migration. Missing Open Graph or Twitter Card tags cause social sharing to fail. Changed titles or descriptions hurt search rankings.

Output: SEO comparison report at `.planning/audit/seo-comparison.json` with tag-by-tag comparison
</objective>

<execution_context>
@/home/deck/.claude/get-shit-done/workflows/execute-plan.md
@/home/deck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-content-seo-validation/04-RESEARCH.md
@.planning/audit/pages.json
@.planning/phases/04-content-seo-validation/04-01-SUMMARY.md
@.planning/phases/04-content-seo-validation/04-02-SUMMARY.md
@/home/deck/Sites/vp-eng-nuxt/composables/usePageMeta.ts
</context>

<tasks>

<task type="auto">
  <name>Create meta tag extraction script</name>
  <files>.planning/scripts/extract-meta.ts</files>
  <action>
    Create TypeScript script at `.planning/scripts/extract-meta.ts` with the following structure:

    **Imports:**
    ```typescript
    import { ofetch } from 'ofetch'
    import * as cheerio from 'cheerio'
    import { readFileSync, writeFileSync } from 'fs'
    import { join } from 'path'
    ```

    **Interfaces:**
    ```typescript
    interface PageEntry {
      url: string
      slug: string
      type: string
      title?: string
    }

    interface MetaTags {
      title?: string
      description?: string
      keywords?: string
      canonical?: string
      og: Record<string, string>
      twitter: Record<string, string>
    }

    interface MetaComparison {
      page: string
      slug: string
      sourceUrl: string
      targetUrl: string
      sourceMeta: MetaTags
      targetMeta: MetaTags
      comparison: {
        matches: string[]      // Tags that match
        missing: string[]      // Tags in source but not target
        different: string[]    // Tags with different values
        extra: string[]        // Tags in target but not source
      }
      score: {
        matchRate: number      // Percentage of matching tags
        criticalMatch: boolean // All critical tags present
      }
    }

    interface SeoComparisonReport {
      generated: string
      source: string
      target: string
      pagesCompared: number
      summary: {
        perfectMatches: number
        withMissing: number
        withDifferences: number
        withExtra: number
        avgMatchRate: number
      }
      comparisons: MetaComparison[]
    }
    ```

    **Functions to implement:**

    1. `function extractMetaTags(html: string): MetaTags`
       - Load HTML with Cheerio
       - Extract title element text
       - Extract meta[name="description"]
       - Extract meta[name="keywords"]
       - Extract link[rel="canonical"]
       - Extract all meta[property^="og:"] into og object
       - Extract all meta[name^="twitter:"] into twitter object
       - Return MetaTags object

    2. `function compareMetaTags(source: MetaTags, target: MetaTags): MetaComparison['comparison']`
       - Compare title tag
       - Compare description tag
       - Compare canonical tag
       - Compare all og:* tags
       - Compare all twitter:* tags
       - Categorize as: matches, missing, different, extra
       - Return categorized comparison

    3. `function calculateScore(source: MetaTags, comparison: MetaComparison['comparison']): MetaComparison['score']`
       - Count total source tags
       - Count matching tags
       - Calculate matchRate = (matches / total) * 100
       - Check if all critical tags present (title, description, og:title, og:image)

    4. `async function fetchPageHtml(url: string): Promise<string>`
       - Use ofetch to fetch page HTML
       - Return raw HTML string
       - Handle errors gracefully (return empty string)

    5. `function mapSourceToTarget(sourceUrl: string, sourceSlug: string): string`
       - Reuse URL mapping from 04-02 script
       - Map WordPress URLs to Nuxt URLs

    6. `async function comparePagesMeta(pages: PageEntry[], sourceUrl: string, targetUrl: string): Promise<SeoComparisonReport>`
       - For each page:
         - Fetch source HTML
         - Fetch target HTML (mapped URL)
         - Extract meta tags from both
         - Compare tags and categorize differences
         - Calculate match score
         - Build comparison object
       - Calculate summary statistics
       - Return complete report

    **Critical tags list (for score calculation):**
    - title
    - description
    - og:title
    - og:description
    - og:image
    - twitter:card
    - twitter:title

    **Main execution:**
    ```typescript
    async function main() {
      const SOURCE_URL = 'https://www.vp-associates.com'
      const TARGET_URL = 'http://localhost:3000'

      // Load pages from audit
      const pagesPath = join(process.cwd(), '.planning', 'audit', 'pages.json')
      const pages: PageEntry[] = JSON.parse(readFileSync(pagesPath, 'utf-8'))

      console.log(`Comparing meta tags for ${pages.length} pages...`)
      console.log(`Source: ${SOURCE_URL}`)
      console.log(`Target: ${TARGET_URL}\n`)

      // Run comparison
      const report = await comparePagesMeta(pages, SOURCE_URL, TARGET_URL)

      // Write report
      const reportPath = join(process.cwd(), '.planning', 'audit', 'seo-comparison.json')
      writeFileSync(reportPath, JSON.stringify(report, null, 2))

      // Log summary
      console.log('=== SEO Meta Tag Comparison Summary ===')
      console.log(`Pages compared: ${report.pagesCompared}`)
      console.log(`\nResults:`)
      console.log(`  Perfect matches: ${report.summary.perfectMatches}`)
      console.log(`  With missing tags: ${report.summary.withMissing}`)
      console.log(`  With different tags: ${report.summary.withDifferences}`)
      console.log(`  With extra tags: ${report.summary.withExtra}`)
      console.log(`  Average match rate: ${report.summary.avgMatchRate.toFixed(1)}%`)

      if (report.summary.withMissing > 0) {
        console.log(`\n⚠️ ${report.summary.withMissing} pages have missing meta tags!`)
        console.log('\nPages with missing tags:')
        report.comparisons
          .filter(c => c.comparison.missing.length > 0)
          .forEach(c => {
            console.log(`  - ${c.page}: missing ${c.comparison.missing.join(', ')}`)
          })
      }
    }

    main().catch(console.error)
    ```

    **Important:**
    - Check all meta tags including Open Graph and Twitter Cards
    - Use proper Cheerio selectors for meta elements
    - Handle missing tags gracefully (undefined vs empty string)
    - Critical tags must be present for social sharing
  </action>
  <verify>Script file exists at `.planning/scripts/extract-meta.ts` with all required functions</verify>
  <done>Meta tag extraction script created with complete implementation</done>
</task>

<task type="checkpoint:human-verify">
  <name>Verify Nuxt dev server is running</name>
  <files>None</files>
  <action>
    The Nuxt dev server should still be running from plan 04-02. Verify it's accessible:

    **How to verify:**
    1. Check if http://localhost:3000 loads in browser or with curl
    2. If not running, start it: `npm run dev`
    3. Wait for server to start

    Expected: Server responds at http://localhost:3000

    If server was stopped, restart it before continuing.
  </action>
  <done>Dev server confirmed running and accessible</done>
</task>

<task type="auto">
  <name>Execute meta tag comparison</name>
  <files>.planning/audit/seo-comparison.json</files>
  <action>
    Run the meta tag extraction and comparison script:

    ```bash
    npx tsx .planning/scripts/extract-meta.ts
    ```

    The script will:
    1. Load pages from `.planning/audit/pages.json`
    2. Fetch each page from source (vp-associates.com)
    3. Fetch corresponding page from target (localhost:3000)
    4. Extract all meta tags from both
    5. Compare tags and categorize differences
    6. Calculate match scores

    Expected runtime: 1-2 minutes.

    After completion, review the report:
    ```bash
    # View pages with missing tags
    cat .planning/audit/seo-comparison.json | jq '.comparisons[] | select(.comparison.missing | length > 0) | {page, missing: .comparison.missing}'

    # view summary
    cat .planning/audit/seo-comparison.json | jq '.summary'
    ```
  </action>
  <verify>`.planning/audit/seo-comparison.json` exists and contains valid JSON with meta tag comparison</verify>
  <done>Meta tag comparison complete with discrepancies identified</done>
</task>

<task type="auto">
  <name>Document SEO comparison findings</name>
  <files>.planning/phases/04-content-seo-validation/04-03-SUMMARY.md</files>
  <action>
    Analyze the SEO comparison report and document findings:

    1. **Pages with perfect matches** - all tags present and correct
    2. **Pages with missing tags** - tags in source but not target (critical issue)
    3. **Pages with different tags** - tags present but different values
    4. **Pages with extra tags** - tags in target but not source (acceptable)

    For each category, identify:
    - Which pages are affected
    - Which specific tags are missing/different
    - Whether differences are intentional (e.g., improved descriptions)

    **Critical findings to flag:**
    - Missing og:title or og:description (breaks Facebook sharing)
    - Missing og:image (breaks social sharing previews)
    - Missing twitter:card tags (breaks Twitter sharing)
    - Changed titles or descriptions (affects SEO)

    **Acceptable differences:**
    - Improved/expanded descriptions
    - Additional meta tags not in original
    - Canonical URL changes (if migration-related)

    Document which differences need fixing vs which are acceptable improvements.
  </action>
  <verify>SEO comparison findings documented with prioritized action items</verify>
  <done>SEO comparison analysis complete with findings recorded</done>
</task>

</tasks>

<verification>
After completion, verify:
1. `.planning/scripts/extract-meta.ts` exists with complete implementation
2. `.planning/audit/seo-comparison.json` exists and contains valid JSON
3. Report includes: generated timestamp, pagesCompared count
4. Summary has counts for: perfectMatches, withMissing, withDifferences, withExtra
5. Comparisons array includes: sourceMeta, targetMeta, matches, missing, different
6. Missing meta tags identified and documented
7. REQ-SEO-001 acceptance criteria met:
   - Title, description, keywords extracted from source
   - Corresponding meta tags verified in target
   - Open Graph tags compared
   - Twitter Card tags compared
   - SEO comparison report generated
</verification>

<success_criteria>
1. Meta tag extraction script created and executes successfully
2. SEO comparison report generated with tag-by-tag comparison
3. Missing or differing meta tags identified
4. Findings documented with prioritized action items
5. REQ-SEO-001 acceptance criteria met
6. Critical social sharing tags (OG, Twitter) verified
</success_criteria>

<output>
After completion, create `.planning/phases/04-content-seo-validation/04-03-SUMMARY.md` with:
- Total pages compared
- Pages with perfect meta tag matches
- Pages with missing tags (list critical missing tags)
- Pages with different tags (intentional vs needing fix)
- Confirmation of REQ-SEO-001 completion
- Next steps recommendation (proceed to 04-04 URL structure and redirects)
</output>
