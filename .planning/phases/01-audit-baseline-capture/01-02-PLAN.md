---
phase: 01-audit-baseline-capture
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - .planning/scripts/capture-baselines.ts
  - .planning/audit/baselines/
  - package.json
autonomous: true

must_haves:
  truths:
    - "Visual screenshots captured for all pages in pages.json"
    - "Three viewports captured per page: mobile (375x812), tablet (768x1024), desktop (1920x1080)"
    - "Full page screenshots capture content below the fold"
    - "Screenshots saved in organized directory structure by page slug"
    - "Dynamic content allowed to load before capture (networkidle + delay)"
  artifacts:
    - path: ".planning/scripts/capture-baselines.ts"
      provides: "Playwright screenshot automation script"
      min_lines: 100
      exports: ["captureScreenshots", "ensureDir"]
    - path: ".planning/audit/baselines/"
      provides: "Directory containing all baseline screenshots"
      contains: "home/mobile.png"
    - path: "package.json"
      provides: "Playwright dependency declaration"
      contains: "\"playwright\":"
  key_links:
    - from: ".planning/scripts/capture-baselines.ts"
      to: ".planning/audit/pages.json"
      via: "fs/promises readFile"
      pattern: "readFile.*pages\\.json"
    - from: ".planning/scripts/capture-baselines.ts"
      to: "https://www.vp-associates.com"
      via: "Playwright page.goto() with networkidle wait"
      pattern: "page\\.goto.*networkidle"
    - from: ".planning/scripts/capture-baselines.ts"
      to: ".planning/audit/baselines/${slug}/${viewport}.png"
      via: "Playwright page.screenshot() with fullPage option"
      pattern: "screenshot.*fullPage.*true"
---

<objective>
Create a Playwright-based screenshot automation script that captures visual baselines for all enumerated pages across three viewports (mobile, tablet, desktop).

Purpose: REQ-AUD-002 requires visual screenshots of all pages before any changes are made. These baselines enable comparison during polish phases to verify no regressions occur.

Output: Executable TypeScript script that generates screenshots in `.planning/audit/baselines/{slug}/{viewport}.png` format.
</objective>

<execution_context>
@/home/deck/.claude/get-shit-done/workflows/execute-plan.md
@/home/deck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-audit-baseline-capture/01-RESEARCH.md
@.planning/phases/01-audit-baseline-capture/01-01-PLAN.md

# Prerequisites from 01-01:
- .planning/audit/pages.json exists with complete page inventory
- Each page entry has: url, slug, type, source fields

# Key implementation details from research:
- Playwright for browser automation and screenshot capture
- Viewports: mobile (375x812), tablet (768x1024), desktop (1920x1080)
- Full page capture (not just viewport)
- Wait strategy: networkidle + 2 second fixed delay for dynamic content
- Chromium browser in headless mode
- Directory structure: baselines/{slug}/{viewport}.png
</context>

<tasks>

<task type="auto">
  <name>Install Playwright and dependencies</name>
  <files>package.json</files>
  <action>
    1. Run `npm install --save-dev playwright` to add Playwright
    2. Run `npx playwright install chromium` to install Chromium browser
    3. Verify installation completes without errors

    Do NOT install other browsers (firefox, webkit) - only Chromium is needed.
    Do NOT modify any existing dependencies besides adding playwright.
  </action>
  <verify>
    1. `grep '"playwright"' package.json` returns the dependency line
    2. `npx playwright --version` executes successfully showing version number
  </verify>
  <done>
    Playwright is installed and Chromium browser is available
  </done>
</task>

<task type="auto">
  <name>Create screenshot capture script with multi-viewport support</name>
  <files>.planning/scripts/capture-baselines.ts</files>
  <action>
    Create `.planning/scripts/capture-baselines.ts` with the following implementation:

    1. Import dependencies: `playwright` (chromium only), `fs/promises`, `path`

    2. Define TypeScript interfaces:
       ```typescript
       interface PageEntry {
         url: string
         slug: string
         title?: string
         type: string
         lastmod?: string
         source: string
       }

       interface ViewportConfig {
         width: number
         height: number
       }
       ```

    3. Define viewport configuration:
       ```typescript
       const viewports: Record<string, ViewportConfig> = {
         mobile: { width: 375, height: 812 },    // iPhone X
         tablet: { width: 768, height: 1024 },   // iPad
         desktop: { width: 1920, height: 1080 }  // Full HD
       }
       ```

    4. Implement `ensureDir(path: string)` function:
       - Use `fs/promises mkdir` with `recursive: true` option
       - Create directory if it doesn't exist
       - No error if directory already exists

    5. Implement `captureScreenshots()` async function:
       a. Load pages from `.planning/audit/pages.json` using `readFile`
       b. Parse JSON as PageEntry array
       c. Launch Chromium browser with `launch({ headless: true })`
       d. Create browser context with `newContext({ viewport: null })` - viewport set per page
       e. For each page in pages array:
          - Log "Capturing: {slug}"
          - For each [device, vp] in Object.entries(viewports):
            i. Create new page with `context.newPage()`
            ii. Set viewport with `page.setViewportSize(vp)`
            iii. Try/catch block for error handling:
              - Navigate with `page.goto(page.url, { waitUntil: 'networkidle', timeout: 30000 })`
              - Wait 2 seconds: `page.waitForTimeout(2000)` for dynamic content
              - Create directory: `ensureDir('.planning/audit/baselines/' + page.slug)`
              - Screenshot with `page.screenshot({ path: '.planning/audit/baselines/' + page.slug + '/' + device + '.png', fullPage: true })`
              - Log "  ✓ {device}"
            iv. Catch errors: Log "  ✗ {device}: {error message}"
            v. Always close page: `page.close()` in finally block
       f. Close browser: `browser.close()`
       g. Log "Capture complete!"

    6. Implement `main()` async function:
       - Call `captureScreenshots()`
       - Handle top-level errors

    7. Add `main().catch(console.error)` at EOF to execute

    Base URL source: Pages from pages.json (created by 01-01)
    Screenshot path pattern: `.planning/audit/baselines/{slug}/{viewport}.png`

    DO NOT modify pages.json - only read from it.
    DO NOT capture other viewports beyond mobile, tablet, desktop.
  </action>
  <verify>
    Run `npx tsx .planning/scripts/capture-baselines.ts` and verify:
    1. Script executes without fatal errors
    2. `.planning/audit/baselines/` directory is created
    3. At minimum, `home/mobile.png`, `home/tablet.png`, `home/desktop.png` exist
    4. Each screenshot file is > 0 bytes (use `ls -l` to check)
    5. Console output shows progress through all pages
  </verify>
  <done>
    All pages from pages.json have three screenshots each (mobile, tablet, desktop) in baselines directory
  </done>
</task>

</tasks>

<verification>
After all tasks complete, verify:
1. `find .planning/audit/baselines -name "*.png" | wc -l` returns count equal to (pages × 3)
2. `ls -R .planning/audit/baselines/` shows directory structure with each page slug having 3 PNG files
3. `file .planning/audit/baselines/home/mobile.png` confirms "PNG image data"
4. Each screenshot is visually complete (open at least one to verify full page capture)
</verification>

<success_criteria>
1. All pages from pages.json have screenshots for all three viewports
2. Screenshots use full page capture (content below fold visible)
3. Directory structure organizes screenshots by page slug
4. File naming convention: {viewport}.png where viewport is mobile, tablet, or desktop
5. Script handles errors gracefully (one page failure doesn't stop entire process)
</success_criteria>

<output>
After completion, create `.planning/phases/01-audit-baseline-capture/01-02-SUMMARY.md` with:
- Number of pages captured
- Total screenshots created (should be pages × 3)
- List of any pages that failed capture (if any)
- Total disk usage of baseline directory
- Sample file paths for reference
</output>
