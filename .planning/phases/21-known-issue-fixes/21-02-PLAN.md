---
phase: 21-known-issue-fixes
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - pages/contact.vue
  - nuxt.config.ts
autonomous: true

must_haves:
  truths:
    - "Build shows no chunks larger than 500KB"
    - "Leaflet is in its own vendor chunk (vendor-leaflet)"
    - "Contact page map still functions correctly"
  artifacts:
    - path: "pages/contact.vue"
      provides: "Contact page with lazy-loaded map"
      contains: "LazyServiceAreaMap"
      not_contains: "<ServiceAreaMap />"
    - path: "nuxt.config.ts"
      provides: "Vite config with manualChunks for Leaflet"
      contains: "vendor-leaflet"
  key_links:
    - from: "pages/contact.vue"
      to: "components/ServiceAreaMap.vue"
      via: "Lazy component prefix"
      pattern: "LazyServiceAreaMap"
    - from: "nuxt.config.ts"
      to: "Leaflet library"
      via: "manualChunks configuration"
      pattern: "leaflet.*vendor-leaflet"
---

<objective>
Eliminate 809KB chunk by lazy-loading the ServiceAreaMap component and configuring Vite manualChunks to split Leaflet into its own vendor chunk.

Purpose: The current build bundles Leaflet (~40KB) synchronously into the main chunk, causing an 809KB bundle warning. ServiceAreaMap is below-the-fold on the contact page (after the form and contact info), making it an ideal candidate for lazy loading.

Output: Contact page uses LazyServiceAreaMap, nuxt.config.ts has manualChunks for Leaflet, build shows no >500KB warnings.
</objective>

<execution_context>
@/Users/austinlaw/.claude/get-shit-done/workflows/execute-plan.md
@/Users/austinlaw/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/21-known-issue-fixes/21-RESEARCH.md
@pages/contact.vue
@nuxt.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Lazy-load ServiceAreaMap component</name>
  <files>pages/contact.vue</files>
  <action>
In pages/contact.vue, change the ServiceAreaMap component to use Nuxt's lazy-loading prefix.

Find line 330 (approximately):
```vue
<ServiceAreaMap />
```

Change to:
```vue
<LazyServiceAreaMap />
```

WHY: The `Lazy` prefix tells Nuxt to dynamically import the component only when it renders. Since ServiceAreaMap is below-the-fold (after the contact form), it won't block initial page load. This prevents Leaflet from being bundled into the main chunk.

NO other changes needed - Nuxt handles the dynamic import automatically.
  </action>
  <verify>
1. `grep -n "ServiceAreaMap" pages/contact.vue` should show only LazyServiceAreaMap
2. Run dev server and verify map still loads on contact page
3. Check Network tab - Leaflet should load lazily after initial page
  </verify>
  <done>
- ServiceAreaMap replaced with LazyServiceAreaMap
- Map still renders correctly on contact page
- Leaflet loads lazily (visible in Network tab)
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure manualChunks for Leaflet</name>
  <files>nuxt.config.ts</files>
  <action>
In nuxt.config.ts, update the vite.build section to include manualChunks configuration.

Find the existing vite config (around line 168):
```typescript
vite: {
  build: {
    chunkSizeWarningLimit: 500,
  },
},
```

Replace with:
```typescript
vite: {
  build: {
    chunkSizeWarningLimit: 500,
    rollupOptions: {
      output: {
        manualChunks(id) {
          if (id.includes('node_modules')) {
            // Split Leaflet into its own chunk (loaded lazily with ServiceAreaMap)
            if (id.includes('leaflet')) {
              return 'vendor-leaflet'
            }
          }
        }
      }
    }
  },
},
```

WHY: This tells Rollup to put all Leaflet-related code into a separate chunk named 'vendor-leaflet'. Combined with lazy-loading the ServiceAreaMap, this chunk will only be loaded when the map component renders.

IMPORTANT: Do NOT add Vue or Nuxt core libraries to manualChunks - they cause "external module" errors in Nuxt 3.6.2+.
  </action>
  <verify>
1. `npm run build` completes without errors
2. Build output should show 'vendor-leaflet' chunk
3. No chunks should be >500KB in build output
  </verify>
  <done>
- manualChunks configured for Leaflet
- Build creates vendor-leaflet chunk
- No >500KB chunk warnings
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify bundle optimization</name>
  <files>nuxt.config.ts, pages/contact.vue</files>
  <action>
Run a production build and verify the chunk splitting worked:

1. Run `npm run build` and capture output
2. Look for:
   - No "chunks larger than 500 kB" warnings
   - A 'vendor-leaflet' chunk in the output
   - Main chunk size reduced

3. Optionally run `npx nuxi analyze` to generate a visual bundle treemap (opens in browser)

4. Verify contact page functionality:
   - Start dev server with `npm run dev`
   - Navigate to /contact
   - Scroll down to the Service Area Map section
   - Verify map loads and displays correctly
   - Verify map interactions work (pan, zoom)
  </action>
  <verify>
1. Build completes without >500KB warnings
2. `npm run build 2>&1 | grep -i "vendor-leaflet"` shows the chunk
3. Contact page map renders and functions correctly
  </verify>
  <done>
- Build shows vendor-leaflet chunk
- No >500KB chunk warnings
- Contact page map loads and works correctly
- FIX-02 requirement satisfied
  </done>
</task>

</tasks>

<verification>
After completing all tasks:
1. `npm run build` shows no chunks >500KB
2. Build output includes 'vendor-leaflet' chunk
3. Contact page map loads lazily and functions correctly
4. `grep "LazyServiceAreaMap" pages/contact.vue` returns match
5. `grep "vendor-leaflet" nuxt.config.ts` returns match
</verification>

<success_criteria>
- ServiceAreaMap is lazy-loaded via LazyServiceAreaMap prefix
- Leaflet is split into vendor-leaflet chunk via manualChunks
- Build shows no chunks exceeding 500KB
- Contact page map still functions correctly
- FIX-02 requirement satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/21-known-issue-fixes/21-02-SUMMARY.md`
</output>
